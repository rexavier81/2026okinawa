var SHEET_NAME = "data";
// 設定預設日幣匯率 (如果找不到匯率API會用這個)
var DEFAULT_JPY_RATE = 0.22; 

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var doc = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = doc.getSheetByName(SHEET_NAME);
    
    // 取得目前最後一列的行數，用於寫入公式
    var nextRow = sheet.getLastRow() + 1;

    // --- 處理 POST (新增資料) ---
    if (e.postData) {
      var params = JSON.parse(e.postData.contents);
      
      // 準備寫入的資料
      var time = new Date(); // A欄: 時間戳記
      var date = params.date; // B欄
      var item = params.item; // C欄
      var payer = params.payer; // D欄
      var amount = params.amount; // E欄
      var currency = params.currency; // F欄
      var note = params.note || "active"; // I欄: 預設為 active
      
      // G欄: 匯率邏輯 (如果是台幣就是1，日幣就用傳進來的匯率)
      var rate = (currency === "TWD") ? 1 : params.rate;

      // H欄: 寫入 Excel 公式自動計算 (=E欄 * G欄)
      // 例如第5列: =E5*G5
      var twdFormula = "=E" + nextRow + "*G" + nextRow;

      // 寫入整列資料 (A~I)
      sheet.appendRow([time, date, item, payer, amount, currency, rate, twdFormula, note]);
      
      return ContentService.createTextOutput(JSON.stringify({result: "success"}))
        .setMimeType(ContentService.MimeType.JSON);
    } 
    
    // --- 處理 GET (讀取資料) ---
    else {
      var data = sheet.getDataRange().getValues();
      var rows = data.slice(1); // 去掉標題
      
      // 過濾資料：只回傳 note 不是 "deleted" 的資料
      var result = rows
        .filter(function(row) {
          // 檢查 I欄 (Index 8) 是否包含 deleted
          return String(row[8]).toLowerCase().indexOf("deleted") === -1;
        })
        .map(function(row) {
          return {
            date: formatDate(row[1]), // 格式化日期
            item: row[2],
            payer: row[3],
            amount: row[4],
            currency: row[5],
            rate: row[6],
            twd: row[7], // 這裡會抓到公式計算後的結果
            note: row[8]
          };
        });
      
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({result: "error", error: err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// 輔助函式：格式化日期為 YYYY-MM-DD
function formatDate(dateObj) {
  if (!dateObj) return "";
  try {
    var d = new Date(dateObj);
    // 處理時區問題，簡單轉字串
    return Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd");
  } catch (e) {
    return dateObj;
  }
}
