<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœˆï¸2026æ²–ç¹©8å¤©7å¤œâœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f9ff; color: #333; overscroll-behavior-y: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe-top { padding-top: max(env(safe-area-inset-top), 1rem); }
        .tab-content { display: none; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        .desc-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; white-space: pre-wrap; transition: all 0.3s ease; }
        .desc-text.expanded { -webkit-line-clamp: unset; }
        .timeline-line { position: absolute; left: 27px; top: 3.5rem; bottom: -1rem; width: 2px; background-color: #bfdbfe; z-index: 0; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.hidden-modal { opacity: 0; visibility: hidden; pointer-events: none; }
        .modal.show-modal { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hidden-modal .modal-content { transform: scale(0.9) translateY(20px); }
        .show-modal .modal-content { transform: scale(1) translateY(0); }
        .desc-text a { color: #2563eb; text-decoration: underline; font-weight: 500; }
        #settlement-content { transition: max-height 0.3s ease-out, opacity 0.3s ease; overflow: hidden; max-height: 0; opacity: 0; }
        #settlement-content.open { max-height: 500px; opacity: 1; }
        #arrow-settlement { transition: transform 0.3s ease; }
        #arrow-settlement.rotate { transform: rotate(180deg); }
        
        /* èªéŸ³æ³¢ç´‹å‹•ç•« */
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }
        .recording-pulse { position: relative; }
        .recording-pulse::before { content: ''; position: absolute; left: 0; top: 0; width: 100%; height: 100%; background-color: #ef4444; border-radius: 50%; z-index: -1; animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        
        /* é€²åº¦æ¢å‹•ç•« */
        .progress-bar { transition: width 0.5s ease-in-out, background-color 0.5s ease; }
        
        /* è§£æ±º iOS é»æ“Šå»¶é²èˆ‡é¸å–å•é¡Œ */
        .touch-manipulation { touch-action: manipulation; }

        /* å¤©æ°£è† å›Šå‹•ç•« */
        .weather-capsule { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden max-w-md mx-auto bg-gray-50 shadow-2xl relative">

    <header class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white px-5 pt-safe-top pb-4 shadow-md z-50 shrink-0 relative">
        <div class="flex justify-between items-center pt-2">
            <div>
                <h1 class="text-xl font-bold tracking-tight">2026 æ²–ç¹© 8å¤©7å¤œ</h1>
                <p class="text-blue-100 text-sm opacity-90 mt-1">2/8 (æ—¥) - 2/15 (æ—¥)</p>
            </div>
        </div>
    </header>

    <main id="app-container" class="flex-1 overflow-y-auto relative bg-sky-50/50 pb-24">
        <div id="loading-msg" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-full text-sm z-50">è³‡æ–™åŒæ­¥ä¸­...</div>

        <div id="view-itinerary" class="tab-content active">
            <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-sm border-b border-gray-200 py-3 shadow-sm">
                <div id="day-selector" class="flex px-4 gap-3 overflow-x-auto hide-scrollbar"></div>
            </div>
            <div id="itinerary-list" class="p-4 space-y-4"></div>
        </div>

        <div id="view-flights" class="tab-content p-5 space-y-4"></div>
        <div id="view-hotels" class="tab-content p-5 space-y-4"></div>
        <div id="view-mustbuy" class="tab-content p-5 space-y-4"><div id="mustbuy-list" class="space-y-6"></div></div>

        <div id="view-accounting" class="tab-content p-5 space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-4 relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2" id="form-title">ğŸ’¸ æ–°å¢æ¶ˆè²»</h2>
                    <button id="btn-cancel-edit" onclick="resetFormState()" class="hidden text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full font-bold">âœ• å–æ¶ˆ</button>
                </div>
                <form id="account-form" class="space-y-4" onsubmit="submitExpense(event)">
                    <input type="hidden" id="edit-row-id" value="">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label><input type="date" id="acc-date" required class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾äºº</label><select id="acc-payer" onchange="updateRateInputLogic()" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"><option value="å…¬è²»">å…¬è²» (å…±åŒæ¶ˆè²»)</option><option value="å…¬è²»-ç¿”">å…¬è²» (å¹«ç¿”ä»˜)</option><option value="å…¬è²»-å½¥">å…¬è²» (å¹«å½¥ä»˜)</option><option value="ç¿”">ç¿” (ç§äººä»£å¢Š)</option><option value="å½¥">å½¥ (ç§äººä»£å¢Š)</option></select></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">é …ç›®åç¨±</label><input type="text" id="acc-item" required placeholder="ä¾‹å¦‚ï¼šç‡’è‚‰ã€åœè»Šè²»" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">å¹£åˆ¥</label><select id="acc-currency" onchange="updateRateInputLogic()" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"><option value="JPY">ğŸ‡¯ğŸ‡µ æ—¥å¹£</option><option value="TWD">ğŸ‡¹ğŸ‡¼ å°å¹£</option></select></div>
                        <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1 flex justify-between"><span>é‡‘é¡</span><span id="rate-display-area" class="text-[10px] text-gray-400 font-normal hidden flex items-center gap-1">åŒ¯ç‡: <input type="number" id="acc-custom-rate" class="w-16 border-b border-gray-300 text-center text-cyan-600 focus:outline-none bg-transparent" step="0.0001"></span></label><input type="number" id="acc-amount" required placeholder="è¼¸å…¥æ•¸å­—" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-lg font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨» (é¸å¡«)</label><input type="text" id="acc-note" placeholder="..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                    <button type="submit" id="btn-submit-acc" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-xl shadow-md transition-all active:scale-95">è¨˜å¸³</button>
                </form>
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-4 flex justify-between items-center shadow-sm">
                <div>
                    <h2 class="text-xs font-bold text-blue-400 mb-1 uppercase tracking-wider">ğŸ‡¯ğŸ‡µ å…¬æ¬¾æ—¥å¹£é¤˜é¡</h2>
                    <div class="text-2xl font-black text-blue-800 tracking-tight">Â¥<span id="public-balance">0</span></div>
                    <div class="text-[10px] text-gray-400 mt-1 flex gap-2 items-center">
                        <span>ç¾é‡‘åŒ¯ç‡: <span id="avg-rate-display" class="font-bold text-gray-600">--</span></span>
                        <span class="text-blue-400 font-medium">(ç´„ NT$<span id="public-balance-twd">0</span>)</span>
                    </div>
                </div>
                <button onclick="toggleExchangeModal()" class="bg-white border border-blue-200 text-blue-600 text-xs px-3 py-2 rounded-lg font-bold shadow-sm active:scale-95 hover:bg-blue-50 transition-colors flex flex-col items-center"><span class="text-lg mb-0.5">ğŸ’±</span><span>æ›åŒ¯</span></button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-4">
                <div class="flex justify-between items-center mb-1"><p class="text-xs text-gray-500 font-bold">ç¸½æ”¯å‡º (æ›ç®—å°å¹£)</p><div class="flex gap-2"><button onclick="toggleSettlement()" class="text-[10px] text-orange-600 font-bold bg-orange-50 px-2 py-1 rounded-full border border-orange-200 flex items-center gap-1">ğŸ’° çµç®— <svg id="arrow-settlement" class="w-3 h-3 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><button onclick="fetchData()" class="text-[10px] text-cyan-600 font-bold bg-cyan-50 px-2 py-1 rounded-full border border-cyan-200">â†» æ›´æ–°</button></div></div>
                <div class="flex justify-between items-end border-b border-gray-100 pb-4 mb-3"><p class="text-3xl font-black text-cyan-700" id="total-expense">0</p></div>
                <div id="settlement-content" class="bg-orange-50 border border-orange-100 p-3 rounded-lg text-sm text-orange-800 mt-2"><p class="font-bold mb-1">ğŸ’° çµç®—å»ºè­° (ä¸å«å…¬è²»)ï¼š</p><p id="settlement-text">è¨ˆç®—ä¸­...</p></div>
            </div>
            <div><h3 class="font-bold text-gray-700 mb-3 px-1">æ¶ˆè²»æ˜ç´°</h3><div id="expense-list" class="space-y-3 pb-10 text-center text-gray-400 text-sm">è¼‰å…¥ä¸­...</div></div>
        </div>
    </main>

    <div class="fixed bottom-24 right-5 z-40 flex flex-col items-end gap-3 group pointer-events-none">
        <div id="fab-menu" class="flex flex-col items-end gap-3 transition-all duration-300 transform origin-bottom scale-0 opacity-0 translate-y-10">
            <button onclick="showImageModal('æ²–ç¹©å–®è»Œé›»è»Šåœ°åœ–.jpg'); toggleFab();" class="pointer-events-auto flex items-center gap-2 group/item"><span class="bg-gray-800/80 text-white text-xs px-2 py-1 rounded backdrop-blur-sm opacity-0 group-hover/item:opacity-100 transition-opacity">å–®è»Œåœ°åœ–</span><div class="bg-emerald-500 hover:bg-emerald-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center border-2 border-white transition-transform hover:scale-110"><span class="text-xl">ğŸ—ºï¸</span></div></button>
            <button onclick="toggleTaxCalc(); toggleFab();" class="pointer-events-auto flex items-center gap-2 group/item"><span class="bg-gray-800/80 text-white text-xs px-2 py-1 rounded backdrop-blur-sm opacity-0 group-hover/item:opacity-100 transition-opacity">å…ç¨…æ¹Šå–®</span><div class="bg-orange-500 hover:bg-orange-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center border-2 border-white transition-transform hover:scale-110"><span class="text-xl">ğŸ›ï¸</span></div></button>
            <button onclick="toggleTranslate(); toggleFab();" class="pointer-events-auto flex items-center gap-2 group/item"><span class="bg-gray-800/80 text-white text-xs px-2 py-1 rounded backdrop-blur-sm opacity-0 group-hover/item:opacity-100 transition-opacity">ç¿»è­¯æ©Ÿ</span><div class="bg-violet-600 hover:bg-violet-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center border-2 border-white transition-transform hover:scale-110"><span class="text-xl">ğŸ—£ï¸</span></div></button>
            <button onclick="toggleCalc(); toggleFab();" class="pointer-events-auto flex items-center gap-2 group/item"><span class="bg-gray-800/80 text-white text-xs px-2 py-1 rounded backdrop-blur-sm opacity-0 group-hover/item:opacity-100 transition-opacity">åŒ¯ç‡è¨ˆç®—</span><div class="bg-pink-500 hover:bg-pink-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center border-2 border-white transition-transform hover:scale-110"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg></div></button>
        </div>
        <button id="fab-main" onclick="toggleFab()" class="pointer-events-auto bg-gray-800 hover:bg-gray-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-all duration-300 active:scale-95 border-2 border-white/20 z-50"><span id="fab-icon" class="text-2xl transition-transform duration-300">ğŸ› ï¸</span></button>
    </div>

    <div id="universal-image-modal" class="fixed inset-0 z-[95] flex items-center justify-center px-4 modal hidden-modal"><div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="closeImageModal()"></div><div class="relative z-10 w-full max-w-4xl h-full flex items-center justify-center p-4"><img id="modal-image-src" src="" alt="é è¦½åœ–ç‰‡" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl"><button onclick="closeImageModal()" class="absolute top-6 right-6 bg-white/20 hover:bg-white/40 text-white w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm transition-colors text-xl font-bold">âœ•</button></div></div>

    <div id="tax-modal" class="fixed inset-0 z-[90] flex items-center justify-center px-4 modal hidden-modal"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleTaxCalc()"></div><div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative z-10 flex flex-col max-h-[85vh]"><div class="bg-orange-500 p-4 text-white flex justify-between items-center shrink-0"><h3 class="font-bold text-lg flex items-center gap-2">ğŸ›ï¸ å…ç¨…æ¹Šå–®ç¥å™¨</h3><button onclick="toggleTaxCalc()" class="text-white/80 hover:text-white">âœ•</button></div><div class="p-4 space-y-4 flex-1 overflow-y-auto"><div class="text-center sticky top-0 bg-white z-10 pb-2 border-b border-gray-100"><p class="text-sm text-gray-500 mb-1">ç›®æ¨™ï¼šå«ç¨…æ»¿ 5,500 æ—¥åœ“</p><div class="relative pt-1"><div class="overflow-hidden h-4 mb-2 text-xs flex rounded bg-gray-200"><div id="tax-progress" class="progress-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-orange-400 w-0"></div></div></div><div class="flex justify-between items-end px-2"><div class="text-left"><p class="text-xs text-gray-400">ç›®å‰ç¸½è¨ˆ</p><p class="text-2xl font-black text-gray-800">Â¥<span id="tax-total-display">0</span></p></div><div class="text-right"><p id="tax-status" class="text-sm font-bold text-gray-400">è«‹åŠ å…¥å•†å“</p><p id="tax-refund" class="text-xs text-gray-500 h-4"></p></div></div></div><div class="flex gap-2"><input type="text" id="tax-item-name" placeholder="å“é … (é¸å¡«)" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-300"><input type="number" id="tax-item-price" placeholder="Â¥ é‡‘é¡" class="w-24 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-orange-300"><button onclick="addTaxItem()" class="bg-orange-500 text-white w-10 rounded-lg flex items-center justify-center font-bold text-xl shadow-sm active:scale-95">+</button></div><div id="tax-list" class="space-y-2 pb-4"><div class="text-center text-gray-300 text-xs py-4">æ¸…å–®æ˜¯ç©ºçš„</div></div></div></div></div>

    <div id="translate-modal" class="fixed inset-0 z-[80] flex items-center justify-center px-4 modal hidden-modal"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleTranslate()"></div><div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative z-10"><div class="bg-violet-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2">ğŸ‡¯ğŸ‡µ éš¨èº«ç¿»è­¯</h3><button onclick="toggleTranslate()" class="text-white/80 hover:text-white">âœ•</button></div><div class="p-6 flex flex-col items-center gap-4"><textarea id="trans-input" rows="3" class="w-full border border-gray-200 rounded-xl p-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="è¼¸å…¥æˆ–èªªè©± (ä¸­æ–‡)..."></textarea><div class="flex w-full gap-2"><button id="btn-mic" onclick="startDictation()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors"><span class="text-xl">ğŸ¤</span> èªªè©±</button><button onclick="doTranslate()" id="btn-trans-go" class="flex-[2] bg-violet-600 hover:bg-violet-700 text-white py-3 rounded-xl font-bold shadow-md transition-colors">ç¿»è­¯æˆæ—¥æ–‡</button></div><div class="w-full bg-violet-50 rounded-xl p-4 border border-violet-100 relative min-h-[5rem]">
    <p id="trans-result" class="text-xl font-bold text-violet-900 mb-1">...</p><p id="trans-result-en" class="text-sm text-gray-500 font-medium"></p><button onclick="speakResult()" class="absolute bottom-2 right-2 text-violet-600 hover:bg-violet-100 p-2 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg></button></div></div></div></div>

    <div id="exchange-modal" class="fixed inset-0 z-[70] flex items-center justify-center px-4 modal hidden-modal"><div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleExchangeModal()"></div><div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative z-10"><div class="bg-indigo-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2">ğŸ”„ æ–°å¢æ›åŒ¯ç´€éŒ„</h3><button onclick="toggleExchangeModal()" class="text-white/80 hover:text-white">âœ•</button></div><div class="p-5 space-y-4"><div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label><input type="date" id="ex-date" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">èª°æ›çš„</label><select id="ex-who" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2"><option value="ç¿”">ç¿”</option><option value="å½¥">å½¥</option></select></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1">å°å¹£æˆæœ¬ (TWD)</label><input type="number" id="ex-twd" placeholder="ä¾‹å¦‚ï¼š8500" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-lg font-bold text-gray-800"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">æ›å¾—æ—¥å¹£ (JPY)</label><input type="number" id="ex-jpy" placeholder="ä¾‹å¦‚ï¼š38636" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-lg font-bold text-gray-800"></div><button onclick="submitExchange()" id="btn-submit-ex" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-md mt-2">ç¢ºèªæ–°å¢</button><div class="mt-4 pt-4 border-t border-gray-100"><p class="text-xs font-bold text-gray-400 mb-2">æ›åŒ¯æ­·å²</p><div id="exchange-history" class="space-y-2 max-h-32 overflow-y-auto text-xs"></div></div></div></div></div>

    <div id="calc-modal" class="fixed inset-0 z-[70] flex items-center justify-center px-4 modal hidden-modal">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleCalc()"></div>
        <div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative z-10">
            <div class="bg-cyan-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2">ğŸ’± åŒ¯ç‡æ›ç®—</h3><button onclick="toggleCalc()" class="text-white/80 hover:text-white">âœ•</button></div>
            <div class="p-6 space-y-6">
                <div class="text-center text-sm text-gray-500 mb-2">ğŸ’³ åˆ·å¡åŒ¯ç‡ (å«1.5%)ï¼š1 JPY â‰ˆ <span id="display-rate" class="font-bold text-cyan-600 text-lg">--</span> TWD</div>
                <div class="space-y-4">
                    <div class="relative"><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ğŸ‡¯ğŸ‡µ æ—¥å¹£ (JPY)</label><input type="number" id="input-jpy" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-lg font-bold text-gray-800"></div>
                    <div class="relative"><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ğŸ‡¹ğŸ‡¼ æ–°å°å¹£ (TWD)</label><input type="number" id="input-twd" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-lg font-bold text-gray-800"></div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bg-white border-t border-gray-200 shrink-0 pb-safe z-50 fixed bottom-0 w-full max-w-md">
        <div class="grid grid-cols-5 h-16">
            <button onclick="switchTab('itinerary')" id="btn-itinerary" class="nav-btn flex flex-col items-center justify-center w-full h-full text-cyan-600"><span class="text-xl">ğŸ“…</span><span class="text-[10px] font-medium mt-1">è¡Œç¨‹</span></button>
            <button onclick="switchTab('flights')" id="btn-flights" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400"><span class="text-xl">âœˆï¸</span><span class="text-[10px] font-medium mt-1">ç­æ©Ÿ</span></button>
            <button onclick="switchTab('hotels')" id="btn-hotels" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400"><span class="text-xl">ğŸ¨</span><span class="text-[10px] font-medium mt-1">ä½å®¿</span></button>
            <button onclick="switchTab('mustbuy')" id="btn-mustbuy" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400"><span class="text-xl">ğŸ›ï¸</span><span class="text-[10px] font-medium mt-1">å¿…è²·</span></button>
            <button onclick="switchTab('accounting')" id="btn-accounting" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400"><span class="text-xl">ğŸ’°</span><span class="text-[10px] font-medium mt-1">åˆ†å¸³</span></button>
        </div>
    </nav>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwWDFDAIXgnW_CUIz0RDuMIgZC77rbzo3BwVy4FOVOXnsmoXBhzVEc3AZ-0AM3YPrSQ/exec";

        let ALL_EXPENSES = [];
        // â˜…â˜…â˜… å¤©æ°£è³‡æ–™å…¨åŸŸè®Šæ•¸ â˜…â˜…â˜…
        let WEATHER_DATA = {};

        // â˜…â˜…â˜… ç­æ©Ÿèˆ‡ä½å®¿è³‡æ–™ â˜…â˜…â˜…
        const DATA = {
            days: [ { day: 1, date: "2/8 (æ—¥)", title: "æŠµé” & é‚£éœ¸" }, { day: 2, date: "2/9 (ä¸€)", title: "ç§Ÿè»Š & åè­·" }, { day: 3, date: "2/10 (äºŒ)", title: "æ°´æ—é¤¨ & å¤å®‡åˆ©" }, { day: 4, date: "2/11 (ä¸‰)", title: "å—éƒ¨ & æ²–ç¹©ä¸–ç•Œ" }, { day: 5, date: "2/12 (å››)", title: "ä¸­éƒ¨ & ç¾åœ‹æ‘" }, { day: 6, date: "2/13 (äº”)", title: "å¸‚å€ & è³¼ç‰©" }, { day: 7, date: "2/14 (å…­)", title: "ç€¨é•·å³¶ & åœ‹éš›é€š" }, { day: 8, date: "2/15 (æ—¥)", title: "é‚„è»Š & è¿”å°" } ],
            flights: [
                { type: "å»ç¨‹", date: "2/8 (æ—¥)", airline: "æ³°è¶Šæ· VZ568", time: "14:45 - 17:10", from: "æ¡ƒåœ’ T1", to: "é‚£éœ¸", note: "è¨—é‹15å…¬æ–¤ã€é£›è¡Œæ™‚é–“ç‚º1å°æ™‚25åˆ†é˜ã€æ©Ÿå‹ç‚ºç©ºä¸­å·´å£« A320 (ä¸­å‹)ã€ç„¡é¤é»", links: [ { label: "ğŸ”´ æŸ¥çœ‹å³æ™‚å‹•æ…‹ [å ±åˆ°æ«ƒå°ã€ç™»æ©Ÿé–€ã€è¡Œæè½‰ç›¤]", url: "https://tw.trip.com/actualtime/detail?flightNo=VZ568&departCity=TPE&arriveCity=OKA&date=2026-02-08&origin=230&curr=TWD&locale=zh-TW" } ] },
                { type: "å›ç¨‹", date: "2/15 (æ—¥)", airline: "è¯èˆª CI121", time: "11:55 - 12:35", from: "é‚£éœ¸", to: "æ¡ƒåœ’ T2", note: "è¨—é‹23å…¬æ–¤ã€é£›è¡Œæ™‚é–“ç‚º1å°æ™‚40åˆ†é˜ã€ç¶“æ¿Ÿè‰™ç©ºä¸­å·´å£« A350 XWB (å¤§å‹)ã€æœ‰é¤é»", links: [ { label: "ğŸ”´ æŸ¥çœ‹å³æ™‚å‹•æ…‹ [å ±åˆ°æ«ƒå°ã€ç™»æ©Ÿé–€ã€è¡Œæè½‰ç›¤]", url: "https://tw.trip.com/actualtime/detail?flightNo=CI121&departCity=OKA&arriveCity=TPE&date=2026-02-15&locale=zh-TW&curr=TWD" }, { label: "ğŸŒ è¯èˆªç¶²è·¯å ±åˆ°", url: "https://calec.china-airlines.com/eCheckin/eCheckin_home.aspx?country=tw&locale=zh" } ] }
            ],
            hotels: [
                { date: "2/8 - 2/9 (1æ™š)", name: "é‚£éœ¸å°ç¥¿ç«™å‰ysæ—…é¤¨\n(ys inn naha orokuekimae)", breakfast: false, price: 2554, source: "Agoda", checkIn: "12:00", checkOut: "12:00", url: "https://maps.app.goo.gl/v8zTRvvWASqXXVPv5", note: "", voucher: "hotel_ys.pdf" },
                { date: "2/9 - 2/10 (1æ™š)", name: "åè­·Resonex Nagoé£¯åº—\n(Hotel Resonex Nago)", breakfast: true, price: 4129, source: "Agoda", checkIn: "15:00", checkOut: "11:00", url: "https://maps.app.goo.gl/xTf8vqdv3FGSJwth7", note: "", voucher: "hotel_resonex.pdf" },
                { date: "2/10 - 2/15 (5æ™š)", name: "åˆ»ã®å®¿ é‚£è¦‡ by ã‚µãƒ³ãƒ¬ã‚¹ãƒˆãƒªã‚¾ãƒ¼ãƒˆ\n(TOKI NO YADO NAHA)", breakfast: false, price: 10962, source: "ikyu.com", checkIn: "15:00-22:00", checkOut: "11:00", url: "https://maps.app.goo.gl/EenGmCNZVDMrvn3o6", note: "å…¥ä½ä»£ç¢¼ 733562", important: true, qrImage: "å…¥ä½QRCODE.png", trashImage: "å“¡å·¥åœè»Šå ´åƒåœ¾æ¡¶ä½ç½®.png", trashNote: "ç•¶æˆ¿é–“åƒåœ¾æ¡¶æ»¿äº†ï¼Œè«‹ä¸Ÿè‡³å“¡å·¥åœè»Šå ´å…¥å£æ—çš„åƒåœ¾è™•ç†å€ (é»æ“ŠæŒ‰éˆ•çœ‹åœ°åœ–)ã€‚" }
            ],
            shopping: [
                { name: "æ²–ç¹©ä¼´æ‰‹ç¦®", desc: "å„å¼å„æ¨£çš„æ²–ç¹©é™å®šç´€å¿µå“", highlight: "å¿…è²·æ¸…å–®" }, 
                { name: "æ²–ç¹©ç¾é£Ÿ", desc: "ä¸èƒ½éŒ¯éçš„åœ¨åœ°ç¾å‘³", highlight: "ç¾é£Ÿåœ°åœ–" },
                { name: "æ°¸æ—ºå¤¢æ¨‚åŸ", desc: "æ²–ç¹©æœ€å¤§è³¼ç‰©ä¸­å¿ƒï¼Œå¥½é€›å¥½è²·", highlight: "è³¼ç‰©å¤©å ‚" },
                { name: "PARCO CITY", desc: "è‡¨æµ·å¤§å‹å•†å ´ï¼Œå“ç‰Œçœ¾å¤š", highlight: "æ™‚å°šæ½®æµ" },
                { name: "iias æ²–ç¹©è±å´", desc: "é è¿‘æ©Ÿå ´ï¼Œæœ€å¾Œè¡åˆºå¥½å»è™•", highlight: "ä¼‘é–’å¨›æ¨‚" }
            ],
            activities: [
                { dayId: 1, time: "11:00", title: "ğŸš— é–‹è»Šå»åœè»Šå ´", desc: "<a href='https://maps.app.goo.gl/DAcNG4NwXqRsg7qTA' target='_blank'>Times å¤§åœ’é«˜éµåŒ—è·¯äºŒæ®µåœè»Šå ´</a> (åœè»Š1å¤©100å…ƒï¼Œè½‰æ·é‹é ˜èˆªç«™)", type: "transport" },
                { dayId: 1, time: "11:30", title: "ğŸ›« è¾¦ç†ç™»æ©Ÿæ‰‹çºŒ", desc: "æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ (é ˜èˆªç«™-æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆç«™)", type: "transport" },
                { dayId: 1, time: "14:45", title: "âœˆï¸ é£›æ©Ÿèµ·é£›", desc: "æ³°åœ‹è¶Šæ·èˆªç©º VZ568ï¼Œé è¨ˆ 17:05 æŠµé”", type: "flight" },
                { dayId: 1, time: "17:05", title: "ğŸ›¬ å‡ºé—œ", desc: "é‚£éœ¸æ©Ÿå ´ <a href='https://www.facebook.com/share/r/17zbjUwdwr/?mibextid=wwXIfr' target='_blank' class='text-blue-600 underline'>æ©Ÿå ´ç‚¸åˆé¤è‚‰FBä»‹ç´¹</a>", type: "activity" },
                { dayId: 1, time: "18:05", title: "ğŸš† æ­ä¹˜å–®è»Œå‰å¾€é£¯åº—", desc: "å‰å¾€ <a href='https://maps.app.goo.gl/vPCJDYhioHijR7476' target='_blank'>é‚£éœ¸å°ç¥¿ç«™å‰ysæ—…é¤¨</a> Check in", type: "transport" },
                { dayId: 1, time: "18:40", title: "ğŸœ æ™šé¤ï¼šç‰çƒæ–°éºµ é€šå ‚", desc: "<a href='https://maps.app.goo.gl/JSpG8bYnT7qVM6oh6' target='_blank'>é€šå ‚ å°ç¥¿æœ¬åº—</a> (ç”·äººéºµ/å¥³äººéºµ)", type: "food" },
                { dayId: 1, time: "19:40", title: "ğŸ›’ æ™šé¤ã€è¶…å¸‚æ¡è²·", desc: "<a href='https://maps.app.goo.gl/3St2Kjgai1WesYdv8' target='_blank'>æ°¸æ—º é‚£éœ¸åº— (Aeon Naha)</a> æ™šé¤ã€éš¨æ„é€›é€›", type: "shopping" },
                { dayId: 1, time: "21:00", title: "ğŸ¨ ä½å®¿ï¼šé‚£éœ¸å°ç¥¿ç«™å‰ysæ—…é¤¨", desc: "é€€æˆ¿æ™‚é–“ç‚º12:00", type: "hotel" },
                
                { dayId: 2, time: "10:00", title: "ğŸ” æ—©åˆé¤ï¼šA&W æ¼¢å ¡", desc: "<a href='https://www.google.com/maps/search/?api=1&query=A%26W+Naha+Kanagusuku' target='_blank'>A&W Naha Kanagusuku</a> æˆ– <a href='https://www.google.com/maps/search/?api=1&query=Aeon+Naha' target='_blank'>Aeon Naha</a> (ç¶“å…¸ Root Beer)", type: "food" },
                { dayId: 2, time: "12:00", title: "ğŸš† å‰å¾€ç§Ÿè»Šè¡Œ", desc: "å–®è»Œï¼š<a href='https://maps.app.goo.gl/1JoXTvGk3KzBkYby9' target='_blank'>èµ¤å¶ºç«™ (åŒ—å£)</a> æ­ä¹˜æ¥é§è»Š<br><b>ğŸ“¹ <a href='https://www.youtube.com/watch?v=tDy2CliwKS4' target='_blank' class='text-blue-600 underline'>å–®è»Œèµ¤å¶ºç«™ 12:30 æ¥é§æ–¹æ³•</a></b>", type: "transport" },
                { dayId: 2, time: "12:30", title: "ğŸš— å–è»Š (å¤§æ¦®ç§Ÿè»Š)", desc: "å¤§æ¦®ç§Ÿè»Š<br>è»Šæ¬¾ï¼šToyota Yaris<br>è²»ç”¨ï¼šNT$8,400 (ç¾å ´æ”¯ä»˜/æœªå«ä¿éšª)<br>å–®è™Ÿï¼šN0209-0215RC4-08<br>è¨‚è³¼äººï¼šå¾å•Ÿç¿” / 0918-563-811<br><span style='color:#e74c3c; font-weight:bold;'>âš ï¸ è¨˜å¾—å‘ŠçŸ¥ï¼š2/15(æ—¥) 09:30 è¦æ­æ¥é§å»æ©Ÿå ´</span>", type: "transport", tag: "ç§Ÿè»Š", forceOpen: true, mapcode: "33 002 782*33" }, 
                { dayId: 2, time: "13:40", title: "ğŸ¦ åˆé¤ï¼šæµ·é®®åƒçˆ†", desc: "<a href='https://maps.app.goo.gl/VHzgnj1RH9PrVduw8' target='_blank'>ç³»æ»¿é­šå¸‚å ´</a> (æ¨è–¦ç”Ÿé­šç‰‡ã€ç„—çƒ¤é¾è¦) è»Šç¨‹ç´„5åˆ†", type: "food", mapcode: "232 484 136*78" },
                { dayId: 2, time: "15:50", title: "ğŸŒŠ è¬åº§æ¯›", desc: "<a href='https://maps.app.goo.gl/1qQWKJXqCXNiG3hL8' target='_blank'>è¬åº§æ¯› (è±¡é¼»å²©æ™¯è§€)</a> è»Šç¨‹ç´„80åˆ†", type: "activity", mapcode: "206 312 039*17" },
                { dayId: 2, time: "17:00", title: "ğŸ« è²·ç¥¨ & ä¼‘æ¯", desc: "<a href='https://maps.app.goo.gl/MPncpEnoHprksy1h7' target='_blank'>è¨±ç”°ä¼‘æ¯ç«™</a> (è»Šç¨‹ç´„30åˆ†)<br><span style='color:#e74c3c; font-weight:bold;'>âš ï¸ è²·æ°´æ—é¤¨é–€ç¥¨</span>ã€<a href='https://www.facebook.com/share/r/183t8dtLbg/?mibextid=wwXIfr' target='_blank' class='text-blue-600 underline'>åƒç‚¸ç‰©</a>", type: "activity", mapcode: "206 476 706*66" },
                { dayId: 2, time: "17:55", title: "ğŸ¨ é£¯åº— Check-in", desc: "<a href='https://maps.app.goo.gl/nbq8cNbLN9xJVUA98' target='_blank'>ãƒ›ãƒ†ãƒ«ãƒªã‚¾ãƒãƒƒã‚¯ã‚¹åè­·</a> (ç§äººæµ·ç˜æ•£æ­¥ã€å¤•é™½å¾ˆç¾)", type: "hotel", mapcode: "206 597 232*25" },
                { dayId: 2, time: "18:30", title: "ğŸ¥© æ™šé¤ï¼šç‡’è‚‰äº”è‹‘", desc: "<a href='https://maps.app.goo.gl/zvE1ahjbgmokVTaY6' target='_blank'>ç‡’è‚‰äº”è‹‘åè­·åº—</a> (å·²é ç´„ 18:30 2ä½ï¼Œå¯é †é€›éš”å£<a href='https://maps.app.goo.gl/PchKk1p2wReoJpsu8' target='_blank'>æ¼«ç•«å€‰åº«</a>)", type: "food", important: true, menuImage: "ç‡’è‚‰äº”è‹‘åè­·åº—èœå–®.jpg", mapcode: "206 626 507*82" }, 
                { dayId: 2, time: "20:40", title: "ğŸ¨ ä½å®¿ï¼šåè­· Resonex Nago", desc: "éš”å¤©æœ‰é£¯åº—æ—©é¤", type: "hotel" },
                
                { dayId: 3, time: "08:30", title: "ğŸ¥£ æ—©é¤", desc: "ãƒ›ãƒ†ãƒ«ãƒªã‚¾ãƒãƒƒã‚¯ã‚¹åè­· (é£¯åº—æ—©é¤)", type: "food" },
                { dayId: 3, time: "10:00", title: "ğŸ¦ˆ ç¾éº—æµ·æ°´æ—é¤¨", desc: "<a href='https://maps.app.goo.gl/dbvaQEXwrBiSA7ST9' target='_blank'>ç¾éº—æµ·æ°´æ—é¤¨ (é»‘æ½®ä¹‹æµ·)</a> è»Šç¨‹ç´„25åˆ†", type: "activity", important: true, mapcode: "553 075 797*77" },
                { dayId: 3, time: "14:10", title: "ğŸ½ï¸ åˆé¤ï¼šæµ·æ™¯é¤å»³", desc: "<a href='https://maps.app.goo.gl/sSYDqNWzvZ7HDcFXA' target='_blank'>L LOTA (å¤å®‡åˆ©å³¶)</a> è»Šç¨‹ç´„35åˆ†", type: "food", mapcode: "485 692 291*82" },
                { dayId: 3, time: "15:00", title: "ğŸï¸ å¤å®‡åˆ©å³¶å·¡ç¦®", desc: "<a href='https://www.google.com/maps/search/?api=1&query=å¿ƒå½¢å²©' target='_blank'>å¿ƒå½¢å²©</a>ã€<a href='https://www.google.com/maps/search/?api=1&query=å¤å®‡åˆ©æµ·æ´‹å¡”-åœè»Šå ´' target='_blank'>å¤å®‡åˆ©æµ·æ´‹å¡”-åœè»Šå ´</a> (æ²™ç˜ã€æ©‹é ­æ‹ç…§)", type: "activity", mapcode: "485 693 485*11" },
                { dayId: 3, time: "18:00", title: "â˜• æ™šé¤ / ä¸‹åˆèŒ¶", desc: "<a href='https://maps.app.goo.gl/MDAAH3BqAyj3VXZE7' target='_blank'>BANTA CAFE</a> (çœ‹å¤œæ™¯) <a href='https://www.facebook.com/share/r/1U1gyWhzTa/?mibextid=wwXIfr' target='_blank' class='text-blue-600 underline'>FBä»‹ç´¹</a> (å›ç¨‹è¼ƒé ï¼Œé æŠ“1.5hr)", type: "food", mapcode: "33 882 546*47" },
                { dayId: 3, time: "20:20", title: "ğŸ¨ é£¯åº— Check-in", desc: "<a href='https://maps.app.goo.gl/EenGmCNZVDMrvn3o6' target='_blank'>åˆ»ã®å®¿ é‚£è¦‡</a> (åœè»Šï¼š<a href='https://maps.app.goo.gl/wsbADdeUuLNcfMA27' target='_blank'>æ²–ç¸„çœŒæ¨‹å·ç«‹ä½“é§è»Šå ´</a>) å…¥ä½ä»£ç¢¼ï¼š733562ã€è²·éš”å¤©æ—©é¤", type: "hotel", mapcode: "33 128 661*23" }, // â˜…â˜…â˜… ä¿®æ­£ â˜…â˜…â˜…

                { dayId: 4, time: "09:00", title: "ğŸ¥£ æ—©é¤", desc: "<a href='https://maps.app.goo.gl/V5kaFqD58e2bE7Sv8' target='_blank'>åˆ»ã®å®¿ é‚£è¦‡</a>", type: "food" },
                { dayId: 4, time: "09:50", title: "ğŸ° å¤è¹Ÿå·¡ç¦®", desc: "<a href='https://maps.app.goo.gl/DztRTHkY4sjzMtUJ8' target='_blank'>é¦–é‡ŒåŸå…¬åœ’</a> (è»Šç¨‹ç´„20åˆ†)", type: "activity", mapcode: "33 161 526*66" },
                { dayId: 4, time: "11:50", title: "ğŸ½ï¸ åˆé¤", desc: "<a href='https://maps.app.goo.gl/QqgEhdrVPWhsaL936' target='_blank'>æ°¸æ—ºåŸ å—åŸå¤§é‡Œ</a> (è»Šç¨‹ç´„30åˆ†)", type: "food", mapcode: "232 559 133*82" },
                { dayId: 4, time: "13:00", title: "ğŸ‘¹ æ²–ç¹©ä¸–ç•Œæ–‡åŒ–ç‹åœ‹", desc: "<a href='https://maps.app.goo.gl/tmqeh6zTEGffPFcs5' target='_blank'>æ²–ç¹©ä¸–ç•Œåœè»Šå ´</a> (ç‰æ³‰æ´ã€ç‹åœ‹æ‘ï¼›14:30 å¤ªé¼“èˆç§€ã€æ³¢ä¼¯è›‡åœ’)", type: "activity", mapcode: "232 495 330*25" },
                { dayId: 4, time: "16:00", title: "ğŸ›’ å¥½å¸‚å¤šæ¡è³¼", desc: "<a href='https://maps.app.goo.gl/giC5VC7dKfwGsGzCA' target='_blank'>Costco æ²–ç¹©å—åŸå€‰åº«åº—</a> (è²·è‰è“ï¼)", type: "shopping", mapcode: "232 557 289*44" },
                { dayId: 4, time: "17:50", title: "ğŸ‘• æ©Ÿèƒ½æœé£¾", desc: "<a href='https://maps.app.goo.gl/FXV6h1UZdMyiwVYw6' target='_blank'>WORKMAN Yaese</a>", type: "shopping", mapcode: "232 492 531*44" },
                { dayId: 4, time: "19:05", title: "ğŸ› æ™šé¤ï¼šå’–å“©é£¯", desc: "<a href='https://maps.app.goo.gl/GxUUMn6ff7XAX2KR8' target='_blank'>CoCo Ichibanya Round 1 å—é¢¨åŸåº—</a>", type: "food", mapcode: "33 071 832*22" },
                { dayId: 4, time: "20:30", title: "ğŸ¨ è¿”å›ä½å®¿", desc: "<a href='https://maps.app.goo.gl/V5kaFqD58e2bE7Sv8' target='_blank'>åˆ»ã®å®¿ é‚£è¦‡</a> (<a href='https://maps.app.goo.gl/wsbADdeUuLNcfMA27' target='_blank'>æ²–ç¸„çœŒæ¨‹å·ç«‹ä½“é§è»Šå ´</a>)", type: "hotel", mapcode: "33 128 661*23" }, // â˜…â˜…â˜… ä¿®æ­£ â˜…â˜…â˜…

                { dayId: 5, time: "08:30", title: "ğŸœ æ—©é¤ï¼šæ²–ç¹©éºµ", desc: "<a href='https://maps.app.goo.gl/zbk64W2Ut8ctUWN39' target='_blank'>STAND EIBUN</a> (æ­¥è¡Œ4åˆ†é˜ã€‚å¿…é»ï¼šäºç‘Ÿéºµ Arthur Sobaã€å’–å“©éºµ)", type: "food", mapcode: "33 157 236*58" },
                { dayId: 5, time: "10:40", title: "ğŸš— çµ•æ™¯å…œé¢¨", desc: "<a href='https://maps.app.goo.gl/8Pzgtt32syLyKvKq5' target='_blank'>æµ·ä¸­é“è·¯</a> & <a href='https://maps.app.goo.gl/kD8ek67V7KxdL1q96' target='_blank'>æœå ±æ‡¸å´–</a> (åƒè§€ <a href='https://maps.app.goo.gl/BXLSAdsQ2nfprgZj9' target='_blank'>å‘½å¾¡åº­è£½é¹½å·¥å» </a>)", type: "activity", mapcode: "499 576 274*33" }, 
                { dayId: 5, time: "12:10", title: "ğŸ™ é»å¿ƒï¼šç« é­šç‡’", desc: "<a href='https://maps.app.goo.gl/fPvsVg6RrdH3idhZ8' target='_blank'>æ²–ç¸„ã‚¤ã‚¤ãƒ€ã‚³å±‹å¤ªé™½</a> <a href='https://www.facebook.com/reel/1540297270440381' target='_blank' class='text-blue-600 underline'>FBé€£çµä»‹ç´¹</a>", type: "food", mapcode: "499 635 240*36" },
                { dayId: 5, time: "13:00", title: "ğŸ›ï¸ åˆé¤ & é€›è¡—", desc: "<a href='https://maps.app.goo.gl/zy6sQ5hfQgL2LMkc6' target='_blank'>æ°¸æ—ºå¤¢æ¨‚åŸä¾†å®¢å¤¢ Rycom</a> (Porteråœ¨SAC'S BAR Resort)", type: "shopping", mapcode: "33 530 406*45" },
                { dayId: 5, time: "17:00", title: "ğŸ‡ºğŸ‡¸ ç¾åœ‹æ‘ & æ™šé¤", desc: "ç¾åœ‹æ‘ American Village (åœè»Šï¼š<a href='https://maps.app.goo.gl/VPmW5M6dGsJgMtYq8' target='_blank'>åŒ—è°·å…¬åœ’é§è»Šå ´</a>æˆ– <a href='https://maps.app.goo.gl/Rj1LsEiXJLvg5hHo9' target='_blank'>Depot Island</a>ã€‚åƒï¼šTaco Rice Cafe, è±¬è‚‰è›‹é£¯ç³°)", type: "activity", mapcode: "33 525 593*52" },
                { dayId: 5, time: "21:00", title: "ğŸ¨ è¿”å›ä½å®¿", desc: "åˆ»ã®å®¿ é‚£è¦‡ (<a href='https://maps.app.goo.gl/wsbADdeUuLNcfMA27' target='_blank'>æ²–ç¸„çœŒæ¨‹å·ç«‹ä½“é§è»Šå ´</a>)", type: "hotel", mapcode: "33 128 661*23" }, // â˜…â˜…â˜… ä¿®æ­£ â˜…â˜…â˜…

                { dayId: 6, time: "09:30", title: "ğŸŒ¸ è³æ«»", desc: "<a href='https://maps.app.goo.gl/M8S9cDXHb62GqHJ28' target='_blank'>èˆ‡å„€å…¬åœ’</a> (æ­¥è¡Œ 6 åˆ†é˜)", type: "activity", mapcode: "33 128 662*63" },
                { dayId: 6, time: "10:15", title: "ğŸŸ æ—©é¤ï¼šæµ·é®®", desc: "<a href='https://maps.app.goo.gl/Z2Hd63ESntQ4dNAn8' target='_blank'>æ³Šæ¸¯æ¼å¸‚å ´</a> (è»Šç¨‹ç´„15åˆ†)", type: "food", mapcode: "33 216 115*55" },
                { dayId: 6, time: "11:30", title: "â›©ï¸ åƒæ‹œ", desc: "<a href='https://maps.app.goo.gl/K91cPBSJCRj8BWYE7' target='_blank'>æ³¢ä¸Šå®®</a> (åœé™„è¿‘ä»˜è²»åœè»Šå ´)", type: "activity", mapcode: "33 185 023*28" },
                { dayId: 6, time: "12:50", title: "ğŸ© ç”œé»", desc: "<a href='https://maps.app.goo.gl/VwbkZ7LAVcP9Bnw38' target='_blank'>Cream D Omoromachi</a> (ç”Ÿç”œç”œåœˆ) <a href='https://www.facebook.com/reel/845741431632238' target='_blank' class='text-blue-600 underline'>FBä»‹ç´¹</a>", type: "food", mapcode: "33 219 284*44" },
                { dayId: 6, time: "13:40", title: "ğŸ“¸ æ‹ç…§é€›è¡—", desc: "<a href='https://maps.app.goo.gl/yaNpUYjVEf5uJ6g9A' target='_blank'>æ¸¯å·å¤–äººä½å®…</a>", type: "activity", mapcode: "33 340 059*82" },
                { dayId: 6, time: "14:50", title: "ğŸ›ï¸ åˆé¤+è³¼ç‰©å¤§æˆ°", desc: "<a href='https://maps.app.goo.gl/hjxvWREbo3U2d4ky5' target='_blank'>PARCO CITY</a> (æ•˜æ•˜è‹‘3Fã€æ¼¢å ¡æ’2Fã€Porter 1F HANDSå…§ã€é³¥ç‰)", type: "shopping", mapcode: "33 339 031*14" },
                { dayId: 6, time: "19:45", title: "ğŸ‘Ÿ é‹å‹•ç”¨å“", desc: "<a href='https://maps.app.goo.gl/Tq8gR1DcAT4gxgX7A' target='_blank'>Sports Depo å¤©ä¹…åº—</a> (é‹å‹•é‹)", type: "shopping", mapcode: "33 218 578*85" },
                { dayId: 6, time: "21:00", title: "ğŸœ æ™šé¤ï¼šæ‹‰éºµ", desc: "<a href='https://maps.app.goo.gl/cp5a9u7DcSpHjWYBA' target='_blank'>çƒˆç«ãƒ©ãƒ¼ãƒ¡ãƒ³æš–æš®</a> (åœ¨è³¼ç‰©ä¸­å¿ƒåƒæˆ–é–‹è»Šå›å»åƒæ‹‰éºµ ç‡Ÿæ¥­åˆ°2:00a.m.)", type: "food", mapcode: "33 157 622*11" },
                { dayId: 6, time: "22:00", title: "ğŸ¨ è¿”å›ä½å®¿", desc: "åˆ»ã®å®¿ é‚£è¦‡ (<a href='https://maps.app.goo.gl/wsbADdeUuLNcfMA27' target='_blank'>æ²–ç¸„çœŒæ¨‹å·ç«‹ä½“é§è»Šå ´</a>)", type: "hotel", mapcode: "33 128 661*23" }, // â˜…â˜…â˜… æ–°å¢ â˜…â˜…â˜…

                { dayId: 7, time: "09:00", title: "ğŸ¥£ æ—©é¤ï¼šå¸‚å ´å·¡ç¦®", desc: "<a href='https://maps.app.goo.gl/AYwfA4LNNigJvAV78' target='_blank'>ç‰§å¿—å…¬è¨­å¸‚å ´</a> (æ­¥è¡Œ 10 åˆ†é˜)", type: "food", mapcode: "33 157 264*54" },
                
                { dayId: 7, time: "10:40", title: "âœˆï¸ çœ‹é£›æ©Ÿ/æµ·æ™¯", desc: "<a href='https://maps.app.goo.gl/KF5KNjECB1zjpcqo9' target='_blank'>ç€¨é•·å³¶ Umikaji Terrace</a>", type: "activity", mapcode: "33 002 602*22" },
                { dayId: 7, time: "12:00", title: "ğŸ›ï¸ Outlet è³¼ç‰© & åˆé¤", desc: "<a href='https://maps.app.goo.gl/53Hpyq3h2Xz1HZ7d6' target='_blank'>Ashibinaa Outlet</a> (iias æ²–ç¹©è±å´)<br>é€›ï¼šBEAMS, United Arrows, Porter (GRAN SAC'S)<br>åˆé¤ï¼š<a href='https://maps.app.goo.gl/JYRLNqQSZE9YqGxQ8' target='_blank'>æ²–ç¹©èœåœ’ Karakara</a> <a href='https://www.facebook.com/reel/1424317575868459' target='_blank' class='text-blue-600 underline'>FBä»‹ç´¹</a>", type: "shopping", mapcode: "232 544 452*22" }, 
                { dayId: 7, time: "17:45", title: "ğŸŒƒ åœ‹éš›é€š", desc: "è»Šå…ˆåœå›<a href='https://maps.app.goo.gl/pKdmCGuYChxP3R8R8' target='_blank'>åœè»Šå ´</a>ã€‚<br>æ™šé¤ï¼š<a href='https://maps.app.goo.gl/yyxXqMyGrGqCKntVA' target='_blank'>é˜¿å¤è±¬ç«é‹ (TRITON)</a> æˆ– <a href='https://www.facebook.com/share/r/17mmY4VG4P/?mibextid=wwXIfr' target='_blank' class='text-blue-600 underline'>æ²–ç¸„æ–™ç†å±…é…’å±‹ ã¶ã£ãŸ</a>", type: "activity", mapcode: "33 128 661*23" }, // â˜…â˜…â˜… ä¿®æ­£ â˜…â˜…â˜…
                { dayId: 7, time: "21:00", title: "ğŸ¨ è¿”å›ä½å®¿", desc: "<a href='https://maps.app.goo.gl/V5kaFqD58e2bE7Sv8' target='_blank'>åˆ»ã®å®¿ é‚£è¦‡</a> (æ”¶è¡Œæ) (<a href='https://maps.app.goo.gl/wsbADdeUuLNcfMA27' target='_blank'>æ²–ç¸„çœŒæ¨‹å·ç«‹ä½“é§è»Šå ´</a>)", type: "hotel" },
                
                { dayId: 8, time: "07:30", title: "ğŸ¥£ æ—©é¤ / é€€æˆ¿", desc: "åˆ»ã®å®¿ é‚£è¦‡ (æª¢æŸ¥è¡Œæ)", type: "food" },
                { dayId: 8, time: "08:00", title: "ğŸš— å‰å¾€å¤§æ¦®ç§Ÿè»Š", desc: "<a href='https://maps.app.goo.gl/pd7XDm9EWGM1LQvx7' target='_blank'>å¤§æ¦®ç§Ÿè»Š</a> (åŠ æ²¹ & é‚„è»Š)", type: "transport", mapcode: "33 002 782*33" },
                { dayId: 8, time: "09:30", title: "ğŸ›« è¾¦ç†ç™»æ©Ÿæ‰‹çºŒ", desc: "é‚£éœ¸æ©Ÿå ´åœ‹éš›ç·šèˆªå»ˆ (æ­ä¹˜æ¥é§è»Š)", type: "transport" },
                { dayId: 8, time: "11:55", title: "âœˆï¸ é£›æ©Ÿèµ·é£›", desc: "è¯èˆª CI121 (æŠµé”æ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ)", type: "flight" }
            ]
        };

        // ==========================
        // æ ¸å¿ƒé‚è¼¯
        // ==========================
        let currentDayId = 1;
        let AVG_RATE = 0.22; // å¹³å‡åŒ¯ç‡ (é è¨­)

        window.addEventListener('DOMContentLoaded', () => {
            fetchWeather(); // â˜…â˜…â˜… åˆå§‹åŒ–æ™‚æŠ“å–å¤©æ°£ â˜…â˜…â˜…
            renderDaySelector();
            renderItinerary(currentDayId);
            renderFlights();
            renderHotels();
            renderMustBuy();
            
            document.getElementById('acc-date').valueAsDate = new Date("2026-02-08");
            document.getElementById('ex-date').valueAsDate = new Date();
            document.getElementById('acc-custom-rate').value = AVG_RATE;
        });

        // â˜…â˜…â˜… æŠ“å– Open-Meteo å¤©æ°£é å ± (Naha) â˜…â˜…â˜…
        async function fetchWeather() {
            try {
                // æ²–ç¹©é‚£éœ¸åº§æ¨™
                const lat = 26.2124;
                const lon = 127.6809;
                // æŸ¥è©¢ 2026-02-08 ~ 2026-02-15
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia/Tokyo&start_date=2026-02-08&end_date=2026-02-15`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                // æ•´ç†æ•¸æ“šï¼šå°‡ Day 1~8 å°æ‡‰åˆ° API å›å‚³çš„ index 0~7
                if (data.daily) {
                    for (let i = 0; i < data.daily.time.length; i++) {
                        // Day 1 å°æ‡‰ index 0
                        WEATHER_DATA[i + 1] = {
                            min: Math.round(data.daily.temperature_2m_min[i]),
                            max: Math.round(data.daily.temperature_2m_max[i]),
                            rain: data.daily.precipitation_probability_max[i],
                            code: data.daily.weather_code[i]
                        };
                    }
                    // è³‡æ–™æŠ“å®Œå¾Œé‡æ–°æ¸²æŸ“ä¸€æ¬¡è¡Œç¨‹è¡¨é ­
                    renderItinerary(currentDayId);
                }
            } catch (err) {
                console.error("å¤©æ°£æŠ“å–å¤±æ•—", err);
                // å¤±æ•—å°±ç®—äº†ï¼Œä¸å½±éŸ¿ä¸»åŠŸèƒ½
            }
        }

        // å¤©æ°£ä»£ç¢¼è½‰åœ–ç¤º helper
        function getWeatherIcon(code) {
            if (code <= 1) return 'â˜€ï¸'; // æ™´å¤©
            if (code <= 3) return 'â›…'; // å¤šé›²
            if (code <= 48) return 'ğŸŒ«ï¸'; // éœ§
            if (code <= 67) return 'ğŸŒ§ï¸'; // é›¨
            if (code <= 82) return 'â›ˆï¸'; // å¼·é›¨
            return 'ğŸŒ¦ï¸'; // å…¶ä»–
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-cyan-600');
                btn.classList.add('text-gray-400');
            });
            document.getElementById(`btn-${tabName}`).classList.remove('text-gray-400');
            document.getElementById(`btn-${tabName}`).classList.add('text-cyan-600');

            if(tabName === 'accounting') fetchData();
        }

        // --- è¡Œç¨‹ç›¸é—œåŠŸèƒ½ ---
        function selectDay(dayId) {
            currentDayId = dayId;
            renderDaySelector();
            renderItinerary(dayId);
            document.getElementById('app-container').scrollTo({ top: 0, behavior: 'smooth' });
        }
        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = DATA.days.map(d => {
                const isActive = d.day === currentDayId;
                const activeClass = isActive ? 'bg-cyan-600 text-white shadow-md transform scale-105' : 'bg-white text-gray-500 border border-gray-100';
                return `<button onclick="selectDay(${d.day})" class="flex-none flex flex-col items-center justify-center min-w-[3.8rem] py-2 rounded-xl transition-all duration-200 ${activeClass}">
                        <span class="text-[10px] font-medium opacity-90">Day ${d.day}</span>
                        <span class="text-sm font-bold">${d.date.split('(')[0]}</span>
                    </button>`;
            }).join('');
        }
        function renderItinerary(dayId) {
            const list = document.getElementById('itinerary-list');
            const dayData = DATA.days.find(d => d.day === dayId);
            const items = DATA.activities.filter(a => a.dayId === dayId);
            
            // â˜…â˜…â˜… ç”¢ç”Ÿå¤©æ°£ HTML â˜…â˜…â˜…
            let weatherHtml = '';
            const w = WEATHER_DATA[dayId];
            if (w) {
                const icon = getWeatherIcon(w.code);
                const rainClass = w.rain > 50 ? 'text-blue-600 font-bold' : 'text-gray-500';
                weatherHtml = `
                    <div class="weather-capsule ml-3 inline-flex items-center gap-2 bg-blue-50 px-3 py-1 rounded-full border border-blue-100 shadow-sm">
                        <span class="text-lg">${icon}</span>
                        <span class="text-xs font-bold text-gray-700">${w.min}Â°-${w.max}Â°C</span>
                        <span class="text-xs ${rainClass}">â˜” ${w.rain}%</span>
                    </div>
                `;
            }

            let html = `<div class="mb-4 px-1 flex items-center flex-wrap">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">${dayData.title}</h2>
                                <p class="text-sm text-gray-500 mt-1">${dayData.date}</p>
                            </div>
                            ${weatherHtml} </div>`;

            if (items.length === 0) html += `<div class="p-8 text-center text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">æœ¬æ—¥ç„¡ç‰¹å®šè¡Œç¨‹</div>`;
            else {
                html += items.map((item, index) => {
                    const isLast = index === items.length - 1;
                    const typeColor = getTypeColor(item.type);
                    const typeIcon = getTypeIcon(item.type);
                    
                    let menuBtn = item.menuImage ? `<button onclick="event.stopPropagation(); showImageModal('${item.menuImage}')" class="mt-2 text-xs font-bold text-orange-600 bg-orange-50 border border-orange-200 px-3 py-1.5 rounded-lg flex items-center gap-1 hover:bg-orange-100 transition-colors w-fit">ğŸ“– æŸ¥çœ‹èœå–®</button>` : '';

                    // â˜…â˜…â˜… MapCode å„€è¡¨æ¿æ¨£å¼ â˜…â˜…â˜…
                    let mapCodeBlock = item.mapcode ? `
                    <div class="mt-3 bg-slate-800 rounded-lg p-2 flex items-center gap-3 border border-slate-700 shadow-sm" onclick="event.stopPropagation()">
                        <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-lg">ğŸš—</div>
                        <div class="flex-1">
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">MapCode (å°èˆªè¼¸å…¥)</div>
                            <div class="text-lg font-mono font-bold text-white tracking-widest leading-none">${item.mapcode}</div>
                        </div>
                    </div>` : '';

                    const expandedClass = item.forceOpen ? 'expanded' : '';

                    return `<div class="relative pl-4">${!isLast ? '<div class="timeline-line"></div>' : ''}<div class="relative bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-5 ${item.important ? 'border-l-4 border-l-red-400' : ''}"><div class="p-4 flex gap-4" onclick="toggleDesc(this)"><div class="flex flex-col items-center gap-1 min-w-[3.5rem] pt-1"><span class="text-sm font-black text-gray-700 tracking-tight">${item.time}</span><div class="w-9 h-9 rounded-full flex items-center justify-center text-white shadow-md z-10" style="background-color: ${typeColor}">${typeIcon}</div></div><div class="flex-1 min-w-0 pt-1"><h3 class="text-lg font-bold text-gray-800 leading-snug">${item.title}</h3><div class="mt-1 text-sm text-gray-600 desc-text ${expandedClass} leading-relaxed">${item.desc}</div>${item.tag ? `<span class="inline-block bg-blue-50 text-blue-600 text-[10px] px-2 py-0.5 rounded mt-1 font-bold">${item.tag}</span>` : ''}${menuBtn}${mapCodeBlock}</div></div></div></div>`;
                }).join('');
            }
            list.innerHTML = html;
        }
        
        function renderFlights() {
            document.getElementById('view-flights').innerHTML = DATA.flights.map(f => `
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative overflow-hidden mb-4">
                    <div class="absolute top-0 right-0 bg-blue-600 text-white text-xs px-3 py-1 rounded-bl-lg font-bold">${f.type}</div>
                    
                    <div class="flex justify-between items-center mb-4 mt-2">
                        <div class="text-center">
                            <div class="text-3xl font-black text-gray-800">${f.time.split('-')[0].trim()}</div>
                            <div class="text-xs text-gray-500 mt-1">${f.from}</div>
                        </div>
                        <div class="flex-1 flex flex-col items-center px-4">
                            <div class="text-xs text-blue-600 font-bold mb-1">${f.airline}</div>
                            <div class="w-full h-[1px] bg-gray-300"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-black text-gray-800">${f.time.split('-')[1].trim()}</div>
                            <div class="text-xs text-gray-500 mt-1">${f.to}</div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-800 border border-blue-100 mb-3">${f.note}</div>
                    
                    <div class="grid grid-cols-1 gap-2">
                        ${f.links.map(link => `
                            <a href="${link.url}" target="_blank" class="block text-center bg-gray-100 hover:bg-blue-600 hover:text-white text-gray-600 py-2 rounded-lg text-xs font-bold transition-colors">
                                ${link.label}
                            </a>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderHotels() {
            document.getElementById('view-hotels').innerHTML = DATA.hotels.map(h => {
                const voucherBtn = h.voucher 
                    ? `<div class="flex-1"><a href="${h.voucher}" target="_blank" class="flex items-center justify-center w-full h-full bg-teal-50 hover:bg-teal-100 text-teal-700 py-3 rounded-xl text-sm font-bold transition-colors border border-teal-100">ğŸ“„ æŸ¥çœ‹æ†‘è­‰</a></div>` 
                    : '';

                let extraSection = '';
                if (h.qrImage || h.trashImage) {
                    extraSection = `
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        ${h.qrImage ? `<button onclick="showImageModal('${h.qrImage}')" class="flex items-center justify-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2.5 rounded-lg text-xs font-bold transition-colors border border-gray-200">ğŸ“± å…¥ä½ QR Code</button>` : ''}
                        ${h.trashImage ? `<button onclick="showImageModal('${h.trashImage}')" class="flex items-center justify-center gap-1 bg-red-50 hover:bg-red-100 text-red-700 py-2.5 rounded-lg text-xs font-bold transition-colors border border-red-100">ğŸ—‘ï¸ åƒåœ¾è™•ç†</button>` : ''}
                    </div>
                    ${h.trashNote ? `<div class="text-xs text-gray-500 bg-gray-50 p-2 rounded mb-3 border border-gray-100 leading-relaxed">ğŸ’¡ ${h.trashNote}</div>` : ''}
                    `;
                }

                return `
                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 mb-4 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded mb-2 inline-block">${h.date}</div>
                        <div class="${h.breakfast ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'} text-xs font-bold px-2 py-1 rounded">
                            ${h.breakfast ? 'âœ… æœ‰æ—©é¤' : 'âŒ ç„¡æ—©é¤'}
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-800 mb-3 leading-snug whitespace-pre-line">${h.name}</h3>
                    
                    <div class="bg-gray-50 rounded-lg p-3 text-sm space-y-2 border border-gray-100 mb-3">
                        <div class="flex justify-between">
                            <span class="text-gray-500">å…¥ä½/é€€æˆ¿</span>
                            <span class="font-bold text-gray-700">${h.checkIn} / ${h.checkOut}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">è¨‚æˆ¿ä¾†æº</span>
                            <span class="font-bold text-blue-600">${h.source}</span>
                        </div>
                        <div class="flex justify-between border-t border-gray-200 pt-2 mt-1">
                            <span class="text-gray-500">åƒ¹æ ¼</span>
                            <span class="font-black text-lg text-gray-800">NT$${h.price.toLocaleString()}</span>
                        </div>
                    </div>

                    ${h.important ? `<div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-2 text-sm font-bold mb-3 rounded-r">ğŸ”‘ ${h.note}</div>` : ''}

                    ${extraSection}

                    <div class="flex gap-3 h-12">
                        ${voucherBtn}
                        <div class="flex-1">
                            <a href="${h.url}" target="_blank" class="flex items-center justify-center w-full h-full bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-xl text-sm font-bold transition-colors border border-purple-100">
                                ğŸ“ æŸ¥çœ‹åœ°åœ–
                            </a>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function renderMustBuy() {
            const images = ["pic_souvenir.jpg", "pic_food.jpg", "pic_aeon.jpg", "pic_parco.jpg", "pic_iias.jpg"];
            const html = images.map(img => `
                <div class="rounded-xl overflow-hidden shadow-sm border border-gray-100 mb-4">
                    <img src="${img}" alt="å¿…è²·æ¨è–¦" class="w-full h-auto block" onerror="this.onerror=null; this.src='https://placehold.co/600x400?text=åœ–ç‰‡æœªæ‰¾åˆ°';">
                </div>
            `).join('');
            document.getElementById('mustbuy-list').innerHTML = html;
        }

        function toggleDesc(el) { const desc = el.querySelector('.desc-text'); if(desc) desc.classList.toggle('expanded'); }
        function getTypeColor(type) { switch(type) { case 'transport': return '#06b6d4'; case 'flight': return '#2563eb'; case 'hotel': return '#a855f7'; case 'food': return '#f97316'; case 'shopping': return '#ec4899'; default: return '#10b981'; } }
        function getTypeIcon(type) { const icons = { transport: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>', flight: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>', hotel: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m8-2a2 2 0 100-4 2 2 0 000 4zm-6-4a2 2 0 110-4 2 2 0 010 4zm6-10a2 2 0 110-4 2 2 0 010 4zm-6 4a2 2 0 110-4 2 2 0 010 4z"></path></svg>', food: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>', shopping: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>' }; return icons[type] || icons.transport; }

        // --- å°å·¥å…·é‚è¼¯ ---
        let isFabOpen = false;
        function toggleFab() {
            isFabOpen = !isFabOpen;
            const menu = document.getElementById('fab-menu');
            const icon = document.getElementById('fab-icon');
            const mainBtn = document.getElementById('fab-main');

            if (isFabOpen) {
                menu.classList.remove('scale-0', 'opacity-0', 'pointer-events-none', 'translate-y-10');
                icon.innerText = 'âœ•'; // è®Šæˆå‰å‰
                icon.classList.add('rotate-90');
                mainBtn.classList.replace('bg-gray-800', 'bg-red-500'); // è®Šæˆç´…è‰²
            } else {
                menu.classList.add('scale-0', 'opacity-0', 'pointer-events-none', 'translate-y-10');
                icon.innerText = 'ğŸ› ï¸'; // è®Šå›å·¥å…·ç®±
                icon.classList.remove('rotate-90');
                mainBtn.classList.replace('bg-red-500', 'bg-gray-800'); // è®Šå›æ·±ç°è‰²
            }
        }

        // --- å–®è»Œåœ°åœ–é‚è¼¯ (æ–°å¢) ---
        function toggleMap() {
            const modal = document.getElementById('map-modal');
            modal.classList.toggle('hidden-modal');
            modal.classList.toggle('show-modal');
        }

        // --- é€šç”¨åœ–ç‰‡ç‡ˆç®±é‚è¼¯ ---
        function showImageModal(src) {
            const modal = document.getElementById('universal-image-modal');
            const img = document.getElementById('modal-image-src');
            img.src = src;
            modal.classList.remove('hidden-modal');
            modal.classList.add('show-modal');
        }

        function closeImageModal() {
            const modal = document.getElementById('universal-image-modal');
            modal.classList.add('hidden-modal');
            modal.classList.remove('show-modal');
        }

        // --- ç¿»è­¯æ©Ÿé‚è¼¯ ---
        function toggleTranslate() {
            const modal = document.getElementById('translate-modal');
            modal.classList.toggle('hidden-modal');
            modal.classList.toggle('show-modal');
        }

        // èªéŸ³è¾¨è­˜ (Web Speech API)
        function startDictation() {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-TW'; // è¾¨è­˜ä¸­æ–‡
                recognition.continuous = false;
                recognition.interimResults = false;

                const btnMic = document.getElementById('btn-mic');
                btnMic.innerHTML = '<div class="recording-pulse w-4 h-4 bg-red-500 rounded-full"></div> è½å¯«ä¸­...';
                
                recognition.onresult = function(event) {
                    const text = event.results[0][0].transcript;
                    document.getElementById('trans-input').value = text;
                    btnMic.innerHTML = '<span class="text-xl">ğŸ¤</span> èªªè©±';
                };

                recognition.onerror = function(event) {
                    alert('èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼Œè«‹æ‰‹å‹•è¼¸å…¥');
                    btnMic.innerHTML = '<span class="text-xl">ğŸ¤</span> èªªè©±';
                };

                recognition.onend = function() {
                    btnMic.innerHTML = '<span class="text-xl">ğŸ¤</span> èªªè©±';
                };

                recognition.start();
            } else {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜');
            }
        }

        // å‘¼å« GAS é€²è¡Œç¿»è­¯ (ä¿®æ­£ç‚ºæ¥æ”¶ä¸­è‹±é›™èª)
        async function doTranslate() {
            const text = document.getElementById('trans-input').value;
            if (!text) return;

            const btn = document.getElementById('btn-trans-go');
            const resultArea = document.getElementById('trans-result');
            const resultAreaEn = document.getElementById('trans-result-en');
            
            btn.disabled = true;
            btn.innerText = "ç¿»è­¯ä¸­...";
            resultArea.innerText = "...";
            resultAreaEn.innerText = "";

            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'translate', text: text })
                });
                const data = await res.json();
                
                if (data.result === 'success') {
                    resultArea.innerText = data.text; // æ—¥æ–‡
                    resultAreaEn.innerText = data.textEn; // è‹±æ–‡
                } else {
                    const errorMsg = data.msg || data.error || "æœªçŸ¥éŒ¯èª¤";
                    resultArea.innerText = "å¤±æ•—: " + errorMsg;
                }
            } catch (err) {
                console.error(err);
                resultArea.innerText = "é€£ç·šéŒ¯èª¤: " + err.message;
            } finally {
                btn.disabled = false;
                btn.innerText = "ç¿»è­¯æˆæ—¥æ–‡";
            }
        }

        // æœ—è®€æ—¥æ–‡
        function speakResult() {
            const text = document.getElementById('trans-result').innerText;
            if (!text || text === '...') return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            window.speechSynthesis.speak(utterance);
        }

        // --- å…ç¨…è¨ˆç®—æ©Ÿé‚è¼¯ (æ¸…å–®æ¨¡å¼) ---
        function toggleTaxCalc() {
            const modal = document.getElementById('tax-modal');
            modal.classList.toggle('hidden-modal');
            modal.classList.toggle('show-modal');
        }

        let taxList = [];
        const TAX_TARGET = 5500; // å…ç¨…é–€æª» (å«ç¨…)

        function addTaxItem() {
            const nameInput = document.getElementById('tax-item-name');
            const priceInput = document.getElementById('tax-item-price');
            const price = parseFloat(priceInput.value);

            if (!price || price <= 0) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼");
                return;
            }

            taxList.push({
                name: nameInput.value.trim() || 'æœªå‘½åå•†å“',
                price: price
            });

            nameInput.value = '';
            priceInput.value = '';
            nameInput.focus();
            
            renderTaxList();
        }

        function removeTaxItem(index) {
            taxList.splice(index, 1);
            renderTaxList();
        }

        function renderTaxList() {
            const container = document.getElementById('tax-list');
            const totalDisplay = document.getElementById('tax-total-display');
            const progress = document.getElementById('tax-progress');
            const status = document.getElementById('tax-status');
            const refund = document.getElementById('tax-refund');

            let total = 0;
            let html = '';

            taxList.forEach((item, index) => {
                total += item.price;
                html += `
                    <div class="flex justify-between items-center bg-gray-50 border border-gray-100 p-2 rounded-lg">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-bold text-gray-700 truncate">${item.name}</p>
                            <p class="text-xs text-gray-400">Â¥${item.price.toLocaleString()}</p>
                        </div>
                        <button onclick="removeTaxItem(${index})" class="text-gray-400 hover:text-red-500 p-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html || '<div class="text-center text-gray-300 text-xs py-4">æ¸…å–®æ˜¯ç©ºçš„</div>';
            totalDisplay.innerText = total.toLocaleString();

            // æ›´æ–°é€²åº¦æ¢
            const percent = Math.min((total / TAX_TARGET) * 100, 100);
            progress.style.width = percent + '%';

            if (total >= TAX_TARGET) {
                progress.classList.remove('bg-orange-400');
                progress.classList.add('bg-green-500');
                status.innerHTML = `ğŸ‰ å·²é”å…ç¨…é–€æª»ï¼`;
                status.classList.replace('text-gray-400', 'text-green-600');
                status.classList.remove('text-gray-700');
                
                const estimatedRefund = Math.floor(total / 1.1 * 0.1);
                refund.innerText = `é è¨ˆé€€ç¨…ç´„ Â¥${estimatedRefund.toLocaleString()}`;
            } else {
                progress.classList.add('bg-orange-400');
                progress.classList.remove('bg-green-500');
                const diff = TAX_TARGET - total;
                status.innerHTML = `é‚„å·® <span class="text-red-500">Â¥${diff.toLocaleString()}</span> é”æ¨™`;
                status.classList.replace('text-green-600', 'text-gray-400');
                status.classList.add('text-gray-700');
                refund.innerText = '';
            }
        }

        // ç¶å®š Enter éµå¿«é€ŸåŠ å…¥
        document.getElementById('tax-item-price').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') addTaxItem();
        });

        // --- è¨˜å¸³èˆ‡æ›åŒ¯é‚è¼¯ (ä¸è®Š) ---
        function toggleExchangeModal() {
            const modal = document.getElementById('exchange-modal');
            modal.classList.toggle('hidden-modal');
            modal.classList.toggle('show-modal');
        }

        function toggleSettlement() {
            const content = document.getElementById('settlement-content');
            const arrow = document.getElementById('arrow-settlement');
            content.classList.toggle('open');
            arrow.classList.toggle('rotate');
        }

        async function submitExchange() {
            const btn = document.getElementById('btn-submit-ex');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "è™•ç†ä¸­...";

            const payload = {
                action: 'add_exchange',
                date: document.getElementById('ex-date').value,
                who: document.getElementById('ex-who').value,
                twd: document.getElementById('ex-twd').value,
                jpy: document.getElementById('ex-jpy').value
            };

            try {
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("âœ… æ›åŒ¯ç´€éŒ„æˆåŠŸï¼");
                toggleExchangeModal();
                fetchData();
            } catch (err) {
                alert("âŒ é€£ç·šå¤±æ•—");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        let CASH_AVG_RATE = 0.22; 
        let CREDIT_CARD_RATE = 0.225;

        // â˜…â˜…â˜… æ ¸å¿ƒé‚è¼¯ï¼šæ ¹æ“šä»˜æ¬¾äººè‡ªå‹•åˆ‡æ›åŒ¯ç‡ â˜…â˜…â˜…
        function updateRateInputLogic() {
            const currency = document.getElementById('acc-currency').value;
            const payer = document.getElementById('acc-payer').value;
            const rateArea = document.getElementById('rate-display-area');
            const rateInput = document.getElementById('acc-custom-rate');

            if (currency === 'JPY') {
                rateArea.classList.remove('hidden');
                // å…¬è²» = ç”¨ç¾é‡‘ = å¹³å‡åŒ¯ç‡
                if (payer.includes('å…¬è²»')) {
                    rateInput.value = CASH_AVG_RATE.toFixed(4);
                    rateInput.disabled = true;
                    rateInput.classList.add('text-gray-400');
                    rateInput.classList.remove('text-cyan-600');
                } else {
                    // å€‹äºº = åˆ·å¡ = ä¿¡ç”¨å¡å³æ™‚åŒ¯ç‡ (å«1.5%)
                    rateInput.value = CREDIT_CARD_RATE.toFixed(4);
                    rateInput.disabled = false; // å…è¨±å¾®èª¿
                    rateInput.classList.remove('text-gray-400');
                    rateInput.classList.add('text-cyan-600');
                }
            } else {
                rateArea.classList.add('hidden');
                rateInput.value = 1;
            }
        }

        async function submitExpense(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit-acc');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'è™•ç†ä¸­...';

            const currency = document.getElementById('acc-currency').value;
            let rateToSend = document.getElementById('acc-custom-rate').value || CASH_AVG_RATE;
            if (currency === 'TWD') {
                rateToSend = 1;
            }

            const payload = {
                action: document.getElementById('edit-row-id').value ? 'edit_expense' : 'add_expense',
                row: document.getElementById('edit-row-id').value,
                date: document.getElementById('acc-date').value,
                payer: document.getElementById('acc-payer').value,
                item: document.getElementById('acc-item').value,
                currency: currency,
                amount: document.getElementById('acc-amount').value,
                rate: rateToSend, 
                note: document.getElementById('acc-note').value
            };

            try {
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert('âœ… è¨˜å¸³æˆåŠŸï¼');
                resetFormState();
                fetchData();
            } catch (err) {
                alert("âŒ é€£ç·šå¤±æ•—");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function fetchData() {
            const listDiv = document.getElementById('expense-list');
            const totalEl = document.getElementById('total-expense');
            const loadingMsg = document.getElementById('loading-msg');
            loadingMsg.classList.remove('hidden');
            listDiv.style.opacity = '0.5';

            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                
                if (data.error) {
                    listDiv.innerHTML = `<div class="text-center text-red-400 py-4 text-sm">å¾Œç«¯éŒ¯èª¤: ${data.error}</div>`;
                    return;
                }

                if (data.creditCardRate && parseFloat(data.creditCardRate) > 0) {
                    CREDIT_CARD_RATE = parseFloat(data.creditCardRate);
                }

                let totalTWD = 0, totalJPY = 0;
                let exchangeHistoryHtml = '';
                
                if (data.exchanges && data.exchanges.length > 0) {
                    data.exchanges.forEach(ex => {
                        totalTWD += parseInt(ex.twd);
                        totalJPY += parseInt(ex.jpy);
                        exchangeHistoryHtml += `<div class="flex justify-between border-b border-gray-100 pb-1"><span>${ex.date} ${ex.who}</span><span>NT$${ex.twd} â†’ Â¥${ex.jpy}</span></div>`;
                    });
                    
                    if (totalJPY > 0) CASH_AVG_RATE = (totalTWD / totalJPY); 
                }
                
                document.getElementById('avg-rate-display').innerText = CASH_AVG_RATE.toFixed(4);
                
                document.getElementById('display-rate').innerText = CREDIT_CARD_RATE.toFixed(4);
                document.getElementById('exchange-history').innerHTML = exchangeHistoryHtml || '<div class="text-gray-400">å°šç„¡ç´€éŒ„</div>';

                let totalSpentTWD = 0;
                let spentPublicJPY = 0;
                let xiangPaid = 0, yanPaid = 0;
                let extraDebt_YanOwesXiang = 0; 
                let html = '';

                // â˜…â˜…â˜… é—œéµï¼šå„²å­˜æ‰€æœ‰è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¾›æŒ‰éˆ•ä½¿ç”¨ â˜…â˜…â˜…
                ALL_EXPENSES = data.expenses;

                data.expenses.forEach((bill, index) => {
                    let twd = 0;
                    let displaySubText = '';

                    if (bill.currency === 'JPY') {
                        const appliedRate = bill.rate ? parseFloat(bill.rate) : CASH_AVG_RATE;
                        twd = Math.round(bill.amount * appliedRate);
                        displaySubText = `â‰ˆ NT$${twd} <span class="text-xs text-gray-300 ml-1">(åŒ¯ç‡: ${appliedRate.toFixed(4)})</span>`;
                        if (String(bill.payer).startsWith('å…¬è²»')) spentPublicJPY += parseInt(bill.amount);
                    } else {
                        twd = parseInt(bill.amount);
                    }

                    if (bill.payer === 'å…¬è²»' || bill.payer.includes('å…±åŒ')) {} 
                    else if (bill.payer === 'å…¬è²»-ç¿”') extraDebt_YanOwesXiang -= (twd / 2); 
                    else if (bill.payer === 'å…¬è²»-å½¥') extraDebt_YanOwesXiang += (twd / 2);
                    else {
                        totalSpentTWD += twd;
                        if (bill.payer.includes('ç¿”')) xiangPaid += twd;
                        if (bill.payer.includes('å½¥')) yanPaid += twd;
                    }

                    const displayAmt = (bill.currency === 'JPY') ? `Â¥${bill.amount}` : `$${bill.amount}`;
                    let payerLabel = bill.payer.split(' ')[0];
                    if(bill.payer === 'å…¬è²»-ç¿”') payerLabel = 'å…¬è²»(ç¿”)';
                    if(bill.payer === 'å…¬è²»-å½¥') payerLabel = 'å…¬è²»(å½¥)';

                    // â˜…â˜…â˜… æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•å„ªåŒ–ï¼šåŠ å¤§æ„Ÿæ‡‰å€ + ä½¿ç”¨ Index æŸ¥æ‰¾è³‡æ–™ â˜…â˜…â˜…
                    html += `
                    <div class="bg-white border border-gray-100 rounded-xl p-3 shadow-sm flex justify-between items-center relative z-0 mb-3">
                        <div class="flex-1">
                            <div class="font-bold text-gray-800 text-sm">${bill.item}</div>
                            <div class="text-xs text-gray-500 mt-1 flex items-center gap-2">
                                <span class="bg-gray-100 px-2 py-0.5 rounded text-gray-600 font-medium">${payerLabel}</span>
                                <span class="opacity-75">${bill.date}</span>
                            </div>
                            ${bill.note ? `<div class="text-xs text-gray-400 mt-1">${bill.note}</div>` : ''}
                        </div>
                        <div class="text-right flex flex-col items-end z-10">
                            <div class="font-bold text-cyan-700 text-lg">${displayAmt}</div>
                            <div class="text-[10px] text-gray-400">${displaySubText}</div>
                            <div class="flex gap-3 mt-2">
                                <button onclick="editExpense(${index})" class="text-xs text-blue-500 font-bold px-3 py-2 active:bg-blue-50 rounded bg-white border border-blue-100 shadow-sm relative z-20">ä¿®æ”¹</button>
                                <button onclick="deleteExpense(${bill.rowIndex})" class="text-xs text-red-400 font-bold px-3 py-2 active:bg-red-50 rounded bg-white border border-red-100 shadow-sm relative z-20">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>`;
                });

                document.getElementById('expense-list').innerHTML = html || '<div class="text-center text-gray-400 py-4 text-sm">ç›®å‰æ²’æœ‰å¸³ç›®</div>';
                document.getElementById('total-expense').innerText = totalSpentTWD.toLocaleString();
                const currentBalance = totalJPY - spentPublicJPY;
                document.getElementById('public-balance').innerText = currentBalance.toLocaleString();
                // å…¬æ¬¾æ›ç®—å°å¹£ï¼šä½¿ç”¨ç¾é‡‘åŒ¯ç‡
                document.getElementById('public-balance-twd').innerText = Math.round(currentBalance * CASH_AVG_RATE).toLocaleString();
                updateSettlement(xiangPaid, yanPaid, extraDebt_YanOwesXiang);
                updateRateInputLogic(); 
            } catch (err) { listDiv.innerHTML = 'è®€å–å¤±æ•—'; } finally { loadingMsg.classList.add('hidden'); listDiv.style.opacity = '1'; }
        }

        function updateSettlement(xiang, yan, extraDebt = 0) {
            const text = document.getElementById('settlement-text');
            const baseDiff = (xiang - yan) / 2;
            const finalDiff = baseDiff + extraDebt;
            const absVal = Math.round(Math.abs(finalDiff));
            
            if (absVal === 0) text.innerText = "ğŸ‰ å¹³è¡¡";
            else if (finalDiff > 0) text.innerHTML = `å½¥ çµ¦ ç¿” <span class="font-bold text-red-600">$${absVal.toLocaleString()}</span>`;
            else text.innerHTML = `ç¿” çµ¦ å½¥ <span class="font-bold text-red-600">$${absVal.toLocaleString()}</span>`;
        }

        function editExpense(index) { 
            const data = ALL_EXPENSES[index]; 
            if (!data) return;

            document.getElementById('edit-row-id').value = data.rowIndex; 
            document.getElementById('acc-date').value = data.date; 
            document.getElementById('acc-payer').value = data.payer; 
            document.getElementById('acc-item').value = data.item; 
            document.getElementById('acc-currency').value = data.currency; 
            document.getElementById('acc-amount').value = data.amount; 
            document.getElementById('acc-note').value = data.note; 
            document.getElementById('acc-custom-rate').value = data.rate || CASH_AVG_RATE; 
            
            document.getElementById('form-title').innerText = "âœï¸ ä¿®æ”¹å¸³ç›®"; 
            document.getElementById('btn-submit-acc').innerText = "ç¢ºèªæ›´æ–°"; 
            document.getElementById('btn-submit-acc').classList.replace('bg-cyan-600', 'bg-blue-600'); 
            document.getElementById('btn-cancel-edit').classList.remove('hidden'); 
            updateRateInputLogic(); 
            document.getElementById('app-container').scrollTo({ top: 0, behavior: 'smooth' }); 
        }

        async function deleteExpense(rowIndex) { if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return; try { await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'delete_expense', row: rowIndex }) }); alert('ğŸ—‘ï¸ å·²åˆªé™¤'); fetchData(); } catch (e) { alert('å¤±æ•—'); } }
        function resetFormState() { document.getElementById('account-form').reset(); document.getElementById('edit-row-id').value = ''; document.getElementById('acc-date').valueAsDate = new Date(); document.getElementById('form-title').innerText = "ğŸ’¸ æ–°å¢æ¶ˆè²»"; document.getElementById('btn-submit-acc').innerText = "è¨˜å¸³"; document.getElementById('btn-submit-acc').classList.replace('bg-blue-600', 'bg-cyan-600'); document.getElementById('btn-cancel-edit').classList.add('hidden'); updateRateInputLogic(); }
        
        const jpyInput = document.getElementById('input-jpy'); const twdInput = document.getElementById('input-twd');
        function toggleCalc() { const modal = document.getElementById('calc-modal'); modal.classList.toggle('hidden-modal'); modal.classList.toggle('show-modal'); }
        jpyInput.addEventListener('input', (e) => { const val = parseFloat(e.target.value); if (!isNaN(val)) twdInput.value = Math.round(val * CREDIT_CARD_RATE); else twdInput.value = ''; });
        twdInput.addEventListener('input', (e) => { const val = parseFloat(e.target.value); if (!isNaN(val)) jpyInput.value = Math.round(val / CREDIT_CARD_RATE); else jpyInput.value = ''; });
    </script>
</body>
</html>
