<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 æ²–ç¹© 8 å¤© 7 å¤œä¹‹æ—…</title>
    <style>
        /* --- å…¨å±€æ¨£å¼ --- */
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #f5f7fa; margin: 0; padding: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        
        /* é ‚éƒ¨æ¨™é¡Œ */
        .header { background: linear-gradient(135deg, #009688 0%, #4db6ac 100%); color: white; padding: 20px 20px 10px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 22px; }
        .header p { margin: 5px 0 0; font-size: 13px; opacity: 0.9; }

        /* å°è¦½åˆ—èˆ‡ç¯©é¸ */
        .controls-container { background: white; position: sticky; top: 70px; z-index: 99; border-bottom: 1px solid #eee; }
        .search-container { padding: 10px 15px; }
        .search-box { width: 100%; padding: 10px; font-size: 15px; border: 1px solid #ddd; border-radius: 8px; outline: none; box-sizing: border-box; background: #f9f9f9; }
        .filter-container { overflow-x: auto; white-space: nowrap; padding: 5px 15px 10px; scrollbar-width: none; }
        .filter-container::-webkit-scrollbar { display: none; }
        
        /* ç¯©é¸æŒ‰éˆ• */
        .filter-btn { display: inline-flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px 10px; margin-right: 8px; border-radius: 10px; border: 1px solid #eee; background: white; color: #666; cursor: pointer; min-width: 65px; height: 45px; transition: 0.2s; }
        .filter-btn.active { background: #009688; color: white; border-color: #009688; box-shadow: 0 2px 5px rgba(0,150,136,0.3); }
        .btn-main { font-size: 14px; font-weight: bold; line-height: 1.1; margin-bottom: 2px; }
        .btn-sub { font-size: 10px; opacity: 0.8; line-height: 1; }

        /* é€šç”¨å®¹å™¨ */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-bottom: 80px; }
        
        /* è¡Œç¨‹å¡ç‰‡ */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; gap: 12px; }
        .time-box { background: #e0f2f1; color: #00796b; padding: 6px; border-radius: 8px; text-align: center; width: 55px; flex-shrink: 0; display: flex; flex-direction: column; justify-content: center; font-weight: bold; font-size: 13px; height: fit-content; }
        .info-box { flex-grow: 1; }
        .activity { font-size: 16px; font-weight: bold; margin-bottom: 4px; color: #333; }
        .location { font-size: 13px; color: #009688; text-decoration: none; }
        .note { font-size: 12px; color: #666; background: #fafafa; padding: 6px; border-radius: 4px; margin-top: 6px; border-left: 3px solid #ddd; }
        
        /* æ—¥æœŸåˆ†éš”æ¨™é¡Œ */
        .day-header { margin: 20px 0 10px; padding-left: 10px; border-left: 4px solid #009688; color: #009688; font-weight: bold; font-size: 18px; display: flex; align-items: baseline; }
        .day-header span { font-size: 12px; color: #888; margin-left: 8px; font-weight: normal; }

        /* åˆ†å¸³è¡¨å–®æ¨£å¼ (ä»¿æˆªåœ–) */
        .split-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; color: #333; }
        .form-title::before { content: 'ğŸ’¸'; margin-right: 8px; }
        
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; font-weight: 500; }
        
        .form-input, .form-select { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; -webkit-appearance: none; }
        .form-input:focus, .form-select:focus { border-color: #009688; outline: none; }
        
        .rate-hint { font-size: 11px; color: #aaa; text-align: right; margin-top: -10px; margin-bottom: 15px; }
        
        .btn-record { width: 100%; background: #009688; color: white; border: none; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,150,136,0.2); transition: 0.2s; }
        .btn-record:active { transform: scale(0.98); background: #00796b; }
        .btn-record:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* ç¸½æ”¯å‡ºå¡ç‰‡ */
        .total-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: left; }
        .total-label { font-size: 13px; color: #666; font-weight: bold; }
        .total-amount { font-size: 32px; font-weight: 800; color: #009688; margin: 5px 0; letter-spacing: -1px; }
        .total-toggle { font-size: 13px; color: #007bff; cursor: pointer; display: flex; align-items: center; margin-top: 5px; }
        .settlement-details { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; font-size: 14px; line-height: 1.6; color: #555; }
        
        /* æ­·å²ç´€éŒ„åˆ—è¡¨ */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
        .h-left { display: flex; flex-direction: column; }
        .h-item { font-weight: bold; font-size: 15px; color: #333; }
        .h-meta { font-size: 11px; color: #999; margin-top: 2px; }
        .h-right { text-align: right; }
        .h-amount { font-weight: bold; font-size: 15px; }
        .h-twd { font-size: 11px; color: #aaa; }
        .payer-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; color: white; display: inline-block; }

        /* åº•éƒ¨å°è¦½åˆ— */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; color: #aaa; font-size: 10px; padding: 5px 0; cursor: pointer; }
        .nav-item.active { color: #009688; font-weight: bold; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        /* æ‡¸æµ®åŒ¯ç‡æŒ‰éˆ• */
        .fab-btn { position: fixed; bottom: 80px; right: 20px; width: 48px; height: 48px; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; z-index: 900; transition: transform 0.2s; }
        .fab-btn:active { transform: scale(0.9); }
        .fab-btn::after { content: "åŒ¯ç‡"; position: absolute; bottom: 8px; font-size: 7px; color: white; font-weight: bold; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }

        /* åŒ¯ç‡å½ˆçª— */
        .rate-modal { position: fixed; bottom: 140px; right: 20px; width: 260px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 15px; z-index: 999; display: none; }
        .rate-row { margin-bottom: 10px; }
        .rate-row label { display: block; font-size: 11px; color: #888; }
        .rate-row input { width: 100%; padding: 8px; border: 1px solid #eee; border-radius: 6px; text-align: right; font-size: 16px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="header">
        <h1>âœˆï¸ 2026 æ²–ç¹©ä¹‹æ—…</h1>
    </div>

    <div id="topControls" class="controls-container">
        <div class="search-container">
            <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹è¡Œç¨‹...">
        </div>
        <div id="dayFilter" class="filter-container"></div>
    </div>

    <div class="container" id="itineraryContainer"></div>

    <div class="container" id="splitBillContainer" style="display:none;">
        
        <div class="split-card">
            <div class="form-title">æ–°å¢ä¸€ç­†å¸³ç›®</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">æ—¥æœŸ</label>
                    <input type="date" id="billDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">ä»˜æ¬¾äºº</label>
                    <select id="billPayer" class="form-select">
                        <option value="ç¿”">ç¿”</option>
                        <option value="å½¥">å½¥</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label class="form-label">é …ç›®åç¨±</label>
                <input type="text" id="billItem" class="form-input" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€è¨ˆç¨‹è»Š">
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 0.6;">
                    <label class="form-label">å¹£åˆ¥</label>
                    <select id="billCurrency" class="form-select" onchange="updateRateHint()">
                        <option value="JPY">JPY æ—¥å¹£</option>
                        <option value="TWD">TWD å°å¹£</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">é‡‘é¡</label>
                    <input type="number" id="billAmount" class="form-input" placeholder="è¼¸å…¥æ•¸å­—">
                </div>
            </div>

            <div class="rate-hint" id="rateHint">ç•¶å‰åŒ¯ç‡: 1 JPY â‰ˆ 0.22 TWD</div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">å‚™è¨» (é¸å¡«)</label>
                <input type="text" id="billNote" class="form-input" placeholder="è©³ç´°èªªæ˜...">
            </div>

            <button class="btn-record" onclick="addExpense()">è¨˜å¸³</button>
        </div>

        <div class="total-card">
            <div class="total-label">ç¸½æ”¯å‡º (Total)</div>
            <div class="total-amount" id="totalDisplay">$0</div>
            <div class="total-toggle" onclick="toggleSettlement()">
                æŸ¥çœ‹çµç®— <span style="font-size: 10px; margin-left: 5px;">â–¼</span>
            </div>
            <div class="settlement-details" id="settlementDetails">
                æ­£åœ¨è¨ˆç®—ä¸­...
            </div>
        </div>

        <h4 style="margin: 0 0 10px 5px; color: #666;">è¿‘æœŸç´€éŒ„</h4>
        <div id="historyList" style="background: white; border-radius: 16px; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <div style="padding: 20px; text-align: center; color: #999;">è¼‰å…¥ä¸­...</div>
        </div>
        <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #aaa;">
            è‹¥éœ€åˆªé™¤ï¼Œè«‹è‡³ Google Sheet å°‡ note æ”¹ç‚º deleted
        </div>

    </div>

    <div class="fab-btn" onclick="toggleRateModal()">ğŸ’°</div>
    
    <div class="rate-modal" id="rateModal">
        <div style="font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between;">
            å³æ™‚æ›ç®— <span onclick="toggleRateModal()" style="cursor: pointer;">Ã—</span>
        </div>
        <div class="rate-row">
            <label>ğŸ‡¯ğŸ‡µ æ—¥å¹£ (JPY)</label>
            <input type="number" id="inputJPY" oninput="convert('JPY')" placeholder="0">
        </div>
        <div class="rate-row">
            <label>ğŸ‡¹ğŸ‡¼ å°å¹£ (TWD)</label>
            <input type="number" id="inputTWD" oninput="convert('TWD')" placeholder="0">
        </div>
        <div style="text-align: right; font-size: 10px; color: #aaa;" id="rateInfo">è¼‰å…¥åŒ¯ç‡ä¸­...</div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('itinerary', this)"><span class="nav-icon">ğŸ“…</span>è¡Œç¨‹</div>
        <div class="nav-item" onclick="switchTab('mustbuy', this)"><span class="nav-icon">ğŸ›ï¸</span>å¿…è²·</div>
        <div class="nav-item" onclick="switchTab('split', this)"><span class="nav-icon">ğŸ’°</span>åˆ†å¸³</div>
    </div>

    <script>
        // â˜…â˜…â˜… è¨­å®šå€ â˜…â˜…â˜…
        
        // é€™æ˜¯ä½ æä¾›çš„ Google Apps Script ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbwWDFDAIXgnW_CUIz0RDuMIgZC77rbzo3BwVy4FOVOXnsmoXBhzVEc3AZ-0AM3YPrSQ/exec"; 
        
        // â˜…â˜…â˜… æ ¸å¿ƒè³‡æ–™èˆ‡é‚è¼¯ â˜…â˜…â˜…

        const itineraryData = [
            { day: "Day 1", date: "2/8 (æ—¥)", time: "1100-1130", type: "flight", title: "é–‹è»Šå»åœè»Šå ´", location: "Times å¤§åœ’é«˜éµåŒ—è·¯äºŒæ®µ", note: "è½‰æ·é‹é ˜èˆªç«™" },
            { day: "Day 1", date: "2/8 (æ—¥)", time: "1445-1705", type: "flight", title: "é£›æ©Ÿèµ·é£› ğŸ›«", location: "æ¡ƒåœ’æ©Ÿå ´ T1", note: "æ³°è¶Šæ· VZ568" },
            { day: "Day 1", date: "2/8 (æ—¥)", time: "1805-1840", type: "hotel", title: "Check-in", location: "é‚£éœ¸å°ç¥¿ç«™å‰ysæ—…é¤¨", note: "å–®è»Œå°ç¥¿ç«™æ—" },
            { day: "Day 1", date: "2/8 (æ—¥)", time: "1840-1940", type: "food", title: "é€šå ‚æ‹‰éºµ", location: "é€šå ‚ å°ç¥¿æœ¬åº—", note: "ç”·äººéºµ/å¥³äººéºµ" },
            { day: "Day 2", date: "2/9 (ä¸€)", time: "1000-1200", type: "food", title: "A&W æ¼¢å ¡", location: "A&W Naha", note: "Root Beer" },
            { day: "Day 2", date: "2/9 (ä¸€)", time: "1230-1330", type: "car", title: "å¤§æ¦®ç§Ÿè»Šå–è»Š", location: "å¤§æ¦®ç§Ÿè»Š", note: "Toyota Yaris" },
            { day: "Day 2", date: "2/9 (ä¸€)", time: "1340-1430", type: "food", title: "ç³»æ»¿é­šå¸‚å ´", location: "ç³»æ»¿é­šå¸‚å ´", note: "æµ·é®®åƒçˆ†" },
            { day: "Day 2", date: "2/9 (ä¸€)", time: "1830-2030", type: "food", title: "ç‡’è‚‰äº”è‹‘", location: "ç‡’è‚‰äº”è‹‘åè­·åº—", note: "å·²é ç´„" },
            { day: "Day 3", date: "2/10 (äºŒ)", time: "1000-1330", type: "play", title: "ç¾éº—æµ·æ°´æ—é¤¨", location: "ç¾éº—æµ·æ°´æ—é¤¨", note: "é»‘æ½®ä¹‹æµ·" },
            { day: "Day 3", date: "2/10 (äºŒ)", time: "1500-1630", type: "play", title: "å¤å®‡åˆ©å³¶", location: "å¿ƒå½¢å²©", note: "æµ·æ´‹å¡”" },
            { day: "Day 4", date: "2/11 (ä¸‰)", time: "1300-1530", type: "play", title: "æ²–ç¹©ä¸–ç•Œæ–‡åŒ–ç‹åœ‹", location: "ç‰æ³‰æ´", note: "å¤ªé¼“èˆç§€" },
            { day: "Day 4", date: "2/11 (ä¸‰)", time: "1600-1730", type: "play", title: "Costco æ¡è³¼", location: "Costco å—åŸ", note: "è²·è‰è“" },
            { day: "Day 5", date: "2/12 (å››)", time: "0830-0930", type: "food", title: "STAND EIBUN", location: "STAND EIBUN", note: "æ²–ç¹©éºµ" },
            { day: "Day 5", date: "2/12 (å››)", time: "1300-1630", type: "play", title: "æ°¸æ—ºå¤¢æ¨‚åŸ", location: "Rycom", note: "å¾ˆå¥½é€›" },
            { day: "Day 5", date: "2/12 (å››)", time: "1700-2000", type: "play", title: "ç¾åœ‹æ‘", location: "American Village", note: "æ™šé¤è‡ªç†" },
            { day: "Day 6", date: "2/13 (äº”)", time: "1130-1230", type: "play", title: "æ³¢ä¸Šå®®", location: "æ³¢ä¸Šå®®", note: "æ‡¸å´–ä¸Šçš„ç¥ç¤¾" },
            { day: "Day 6", date: "2/13 (äº”)", time: "1450-1930", type: "play", title: "PARCO CITY", location: "PARCO CITY", note: "æ•˜æ•˜è‹‘" },
            { day: "Day 7", date: "2/14 (å…­)", time: "1200-1700", type: "play", title: "Ashibinaa Outlet", location: "Outlet", note: "è²·è²·è²·" },
            { day: "Day 7", date: "2/14 (å…­)", time: "1745-2030", type: "play", title: "åœ‹éš›é€š", location: "åœ‹éš›é€š", note: "æœ€å¾Œæ¡è²·" },
            { day: "Day 8", date: "2/15 (æ—¥)", time: "1155-1235", type: "flight", title: "å›ç¨‹é£›æ©Ÿ", location: "é‚£éœ¸æ©Ÿå ´", note: "CI121" },
            { day: "å¿…è²·", type: "recommendation", title: "ğŸ ä¼´æ‰‹ç¦®æ¸…å–®", image: "https://via.placeholder.com/300x150?text=Souvenir" },
            { day: "å¿…è²·", type: "recommendation", title: "ğŸ›ï¸ PARCO æ”»ç•¥", image: "https://via.placeholder.com/300x150?text=PARCO" }
        ];

        let currentRate = 0.22; // é è¨­æ—¥å¹£åŒ¯ç‡

        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ ---
        document.addEventListener('DOMContentLoaded', () => {
            initItinerary();
            fetchRate();
            // é è¨­æ—¥æœŸç‚ºä»Šå¤©æˆ–ç¬¬ä¸€å¤©
            document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
        });

        // --- é é¢åˆ‡æ› ---
        window.switchTab = function(tab, btn) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');

            // éš±è—æ‰€æœ‰å®¹å™¨
            document.getElementById('itineraryContainer').style.display = 'none';
            document.getElementById('splitBillContainer').style.display = 'none';
            document.getElementById('topControls').style.display = 'none';

            if (tab === 'itinerary') {
                document.getElementById('itineraryContainer').style.display = 'block';
                document.getElementById('topControls').style.display = 'block';
                renderItinerary();
            } else if (tab === 'mustbuy') {
                document.getElementById('itineraryContainer').style.display = 'block';
                renderMustBuy();
            } else if (tab === 'split') {
                document.getElementById('splitBillContainer').style.display = 'block';
                fetchExpenses(); // è¼‰å…¥å¸³æœ¬
            }
        };

        // --- è¡Œç¨‹æ¸²æŸ“ ---
        function initItinerary() {
            const container = document.getElementById('dayFilter');
            const days = [...new Set(itineraryData.filter(i => i.day !== 'å¿…è²·').map(i => i.day))];
            
            let html = '';
            days.forEach((day, idx) => {
                const date = itineraryData.find(i => i.day === day).date;
                html += `<div class="filter-btn ${idx===0?'active':''}" onclick="filterDay('${day}', this)">
                            <div class="btn-main">${day}</div>
                            <div class="btn-sub">${date.split(' ')[0]}</div>
                         </div>`;
            });
            container.innerHTML = html;
            filterDay(days[0]); // é è¨­é¡¯ç¤ºç¬¬ä¸€å¤©
        }

        window.filterDay = function(day, btn) {
            if(btn) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            const data = itineraryData.filter(i => i.day === day);
            renderList(data);
        };

        function renderItinerary() {
            const activeBtn = document.querySelector('.filter-btn.active');
            if(activeBtn) activeBtn.click();
            else filterDay("Day 1");
        }

        function renderMustBuy() {
            const data = itineraryData.filter(i => i.day === 'å¿…è²·');
            const container = document.getElementById('itineraryContainer');
            let html = '<div class="day-header">ğŸ›ï¸ å¿…è²·æ¸…å–®</div>';
            data.forEach(item => {
                html += `<div class="card" style="display:block; padding:0; overflow:hidden;">
                            <img src="${item.image}" style="width:100%; height:150px; object-fit:cover;">
                            <div style="padding:15px;">
                                <div class="activity">${item.title}</div>
                            </div>
                         </div>`;
            });
            container.innerHTML = html;
        }

        function renderList(data) {
            const container = document.getElementById('itineraryContainer');
            let html = '';
            let currentDay = '';
            
            data.forEach(item => {
                if(item.day !== currentDay) {
                    html += `<div class="day-header">${item.day} <span>${item.date}</span></div>`;
                    currentDay = item.day;
                }
                
                html += `<div class="card">
                            <div class="time-box">
                                <div>${item.time.substring(0,2)}:${item.time.substring(2,4)}</div>
                            </div>
                            <div class="info-box">
                                <div class="activity">${item.title}</div>
                                <div class="location">ğŸ“ ${item.location}</div>
                                ${item.note ? `<div class="note">${item.note}</div>` : ''}
                            </div>
                         </div>`;
            });
            container.innerHTML = html;
        }

        // --- â˜…â˜…â˜… åˆ†å¸³èˆ‡åŒ¯ç‡é‚è¼¯ â˜…â˜…â˜… ---

        async function fetchRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                currentRate = data.rates.TWD; // 1 JPY = x TWD
                document.getElementById('rateInfo').innerText = `1 JPY â‰ˆ ${currentRate.toFixed(3)} TWD`;
                updateRateHint();
            } catch (e) { console.error("Rate Error", e); }
        }

        window.updateRateHint = function() {
            const curr = document.getElementById('billCurrency').value;
            const hint = document.getElementById('rateHint');
            if(curr === 'JPY') {
                hint.innerText = `ç•¶å‰åŒ¯ç‡: 1 JPY â‰ˆ ${currentRate.toFixed(3)} TWD`;
            } else {
                hint.innerText = `ç•¶å‰åŒ¯ç‡: 1 TWD = 1 TWD`;
            }
        };

        window.addExpense = function() {
            const date = document.getElementById('billDate').value;
            const payer = document.getElementById('billPayer').value;
            const item = document.getElementById('billItem').value;
            const currency = document.getElementById('billCurrency').value;
            const amount = document.getElementById('billAmount').value;
            const note = document.getElementById('billNote').value;

            if(!date || !item || !amount) { alert("è«‹å¡«å¯«æ—¥æœŸã€é …ç›®èˆ‡é‡‘é¡"); return; }

            const btn = document.querySelector('.btn-record');
            const originalText = btn.innerText;
            btn.innerText = "å„²å­˜ä¸­...";
            btn.disabled = true;

            // æ±ºå®šé€å‡ºçš„åŒ¯ç‡ï¼šå¦‚æœæ˜¯ JPY å°±é€ç•¶å‰åŒ¯ç‡ï¼Œæ˜¯ TWD å°±é€ 1
            const rateToSend = (currency === 'JPY') ? currentRate : 1;

            const payload = {
                date: date,
                payer: payer,
                item: item,
                currency: currency,
                amount: amount,
                rate: rateToSend,
                note: note
            };

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    // æ¸…ç©ºæ¬„ä½
                    document.getElementById('billItem').value = '';
                    document.getElementById('billAmount').value = '';
                    document.getElementById('billNote').value = '';
                    fetchExpenses(); // é‡æ–°æ•´ç†åˆ—è¡¨
                } else {
                    alert("å„²å­˜å¤±æ•—: " + data.msg);
                }
            })
            .catch(err => alert("ç¶²è·¯éŒ¯èª¤"))
            .finally(() => {
                btn.innerText = "è¨˜å¸³";
                btn.disabled = false;
            });
        };

        function fetchExpenses() {
            document.getElementById('historyList').innerHTML = '<div style="padding:20px; text-align:center;">è¼‰å…¥ä¸­...</div>';
            
            fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                renderHistory(data);
                calculateTotal(data);
            });
        }

        function renderHistory(data) {
            const container = document.getElementById('historyList');
            if(data.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#ccc;">å°šç„¡ç´€éŒ„</div>';
                return;
            }

            // å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨ä¸Šé¢)
            data.reverse();

            let html = '';
            data.forEach(row => {
                const payerColor = row.payer === 'ç¿”' ? '#007bff' : '#e91e63';
                const currencyStyle = row.currency === 'JPY' ? 'color:#009688' : 'color:#333';
                
                html += `<div class="history-item">
                            <div class="h-left">
                                <div class="h-item">
                                    <span class="payer-badge" style="background:${payerColor}">${row.payer}</span>
                                    ${row.item}
                                </div>
                                <div class="h-meta">${row.date.slice(5)} Â· ${row.note}</div>
                            </div>
                            <div class="h-right">
                                <div class="h-amount" style="${currencyStyle}">
                                    ${parseInt(row.amount).toLocaleString()} ${row.currency}
                                </div>
                                <div class="h-twd">â‰ˆ NT$ ${Math.round(row.twd)}</div>
                            </div>
                         </div>`;
            });
            container.innerHTML = html;
        }

        function calculateTotal(data) {
            let total = 0;
            let xiangPaid = 0; // ç¿”å·²ä»˜
            let yanPaid = 0;   // å½¥å·²ä»˜

            data.forEach(row => {
                let twd = parseFloat(row.twd);
                total += twd;
                if(row.payer === 'ç¿”') xiangPaid += twd;
                if(row.payer === 'å½¥') yanPaid += twd;
            });

            document.getElementById('totalDisplay').innerText = `$ ${Math.round(total).toLocaleString()}`;

            // çµç®—é‚è¼¯
            const perPerson = total / 2;
            const diff = xiangPaid - perPerson; // ç¿”å¤šä»˜äº†å¤šå°‘ (è² æ•¸ä»£è¡¨å°‘ä»˜)
            
            let settlementHtml = `
                <div>ç¸½æ”¯å‡ºï¼š$${Math.round(total).toLocaleString()}</div>
                <div>æ¯äººæ‡‰åˆ†æ“”ï¼š$${Math.round(perPerson).toLocaleString()}</div>
                <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">
                <div>ğŸ”µ ç¿” å·²ä»˜ï¼š$${Math.round(xiangPaid).toLocaleString()}</div>
                <div>ğŸ”´ å½¥ å·²ä»˜ï¼š$${Math.round(yanPaid).toLocaleString()}</div>
                <div style="margin-top:10px; font-weight:bold; color:#d32f2f;">
                    ğŸ‘‰ ${diff > 0 ? `å½¥ éœ€çµ¦ ç¿” $${Math.round(diff).toLocaleString()}` : `ç¿” éœ€çµ¦ å½¥ $${Math.round(Math.abs(diff)).toLocaleString()}`}
                </div>
            `;
            document.getElementById('settlementDetails').innerHTML = settlementHtml;
        }

        window.toggleSettlement = function() {
            const el = document.getElementById('settlementDetails');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        };

        // --- æ‡¸æµ®åŒ¯ç‡è¨ˆç®—æ©Ÿ ---
        window.toggleRateModal = function() {
            const modal = document.getElementById('rateModal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        };

        window.convert = function(type) {
            const jpyEl = document.getElementById('inputJPY');
            const twdEl = document.getElementById('inputTWD');
            if(type === 'JPY') {
                const val = parseFloat(jpyEl.value);
                if(!isNaN(val)) twdEl.value = Math.round(val * currentRate);
            } else {
                const val = parseFloat(twdEl.value);
                if(!isNaN(val)) jpyEl.value = Math.round(val / currentRate);
            }
        };

    </script>
</body>
</html>
