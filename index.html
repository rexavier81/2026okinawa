<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœˆï¸2026æ²–ç¹©8å¤©7å¤œâœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f9ff; color: #333; overscroll-behavior-y: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe-top { padding-top: max(env(safe-area-inset-top), 1rem); }
        .tab-content { display: none; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        .desc-text { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; white-space: pre-wrap; transition: all 0.3s ease; }
        .desc-text.expanded { -webkit-line-clamp: unset; }
        .timeline-line { position: absolute; left: 27px; top: 3.5rem; bottom: -1rem; width: 2px; background-color: #bfdbfe; z-index: 0; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.hidden-modal { opacity: 0; visibility: hidden; pointer-events: none; }
        .modal.show-modal { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hidden-modal .modal-content { transform: scale(0.9) translateY(20px); }
        .show-modal .modal-content { transform: scale(1) translateY(0); }
        .desc-text a { color: #0284c7; text-decoration: underline; font-weight: 500; }
        #settlement-content { transition: max-height 0.3s ease-out, opacity 0.3s ease; overflow: hidden; max-height: 0; opacity: 0; }
        #settlement-content.open { max-height: 500px; opacity: 1; }
        #arrow-settlement { transition: transform 0.3s ease; }
        #arrow-settlement.rotate { transform: rotate(180deg); }
        
        /* èªéŸ³æ³¢ç´‹å‹•ç•« */
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }
        .recording-pulse { position: relative; }
        .recording-pulse::before { content: ''; position: absolute; left: 0; top: 0; width: 100%; height: 100%; background-color: #ef4444; border-radius: 50%; z-index: -1; animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden max-w-md mx-auto bg-gray-50 shadow-2xl relative">

    <header class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white px-5 pt-safe-top pb-4 shadow-md z-50 shrink-0 relative">
        <div class="flex justify-between items-center pt-2">
            <div>
                <h1 class="text-xl font-bold tracking-tight">2026 æ²–ç¹© 8å¤©7å¤œ</h1>
                <p class="text-blue-100 text-sm opacity-90 mt-1">2/8 (æ—¥) - 2/15 (æ—¥)</p>
            </div>
        </div>
    </header>

    <main id="app-container" class="flex-1 overflow-y-auto relative bg-sky-50/50 pb-24">
        <div id="loading-msg" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-full text-sm z-50">è³‡æ–™åŒæ­¥ä¸­...</div>

        <div id="view-itinerary" class="tab-content active">
            <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-sm border-b border-gray-200 py-3 shadow-sm">
                <div id="day-selector" class="flex px-4 gap-3 overflow-x-auto hide-scrollbar"></div>
            </div>
            <div id="itinerary-list" class="p-4 space-y-4"></div>
        </div>

        <div id="view-flights" class="tab-content p-5 space-y-4"></div>
        <div id="view-hotels" class="tab-content p-5 space-y-4"></div>
        <div id="view-mustbuy" class="tab-content p-5 space-y-4"><div id="mustbuy-list" class="space-y-6"></div></div>

        <div id="view-accounting" class="tab-content p-5 space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-4 relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2" id="form-title">ğŸ’¸ æ–°å¢æ¶ˆè²»</h2>
                    <button id="btn-cancel-edit" onclick="resetFormState()" class="hidden text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full font-bold">âœ• å–æ¶ˆ</button>
                </div>
                <form id="account-form" class="space-y-4" onsubmit="submitExpense(event)">
                    <input type="hidden" id="edit-row-id" value="">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label><input type="date" id="acc-date" required class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾äºº</label><select id="acc-payer" onchange="updateRateInputLogic()" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"><option value="å…¬è²»">å…¬è²» (å…±åŒæ¶ˆè²»)</option><option value="å…¬è²»-ç¿”">å…¬è²» (å¹«ç¿”ä»˜)</option><option value="å…¬è²»-å½¥">å…¬è²» (å¹«å½¥ä»˜)</option><option value="ç¿”">ç¿” (ç§äººä»£å¢Š)</option><option value="å½¥">å½¥ (ç§äººä»£å¢Š)</option></select></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">é …ç›®åç¨±</label><input type="text" id="acc-item" required placeholder="ä¾‹å¦‚ï¼šç‡’è‚‰ã€åœè»Šè²»" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">å¹£åˆ¥</label><select id="acc-currency" onchange="updateRateInputLogic()" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"><option value="JPY">ğŸ‡¯ğŸ‡µ æ—¥å¹£</option><option value="TWD">ğŸ‡¹ğŸ‡¼ å°å¹£</option></select></div>
                        <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1 flex justify-between"><span>é‡‘é¡</span><span id="rate-display-area" class="text-[10px] text-gray-400 font-normal hidden flex items-center gap-1">åŒ¯ç‡: <input type="number" id="acc-custom-rate" class="w-16 border-b border-gray-300 text-center text-cyan-600 focus:outline-none bg-transparent" step="0.0001"></span></label><input type="number" id="acc-amount" required placeholder="è¼¸å…¥æ•¸å­—" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-lg font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨» (é¸å¡«)</label><input type="text" id="acc-note" placeholder="..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-gray-800 focus:outline-none focus:ring-2 focus:ring-cyan-500"></div>
                    <button type="submit" id="btn-submit-acc" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-xl shadow-md transition-all active:scale-95">è¨˜å¸³</button>
                </form>
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-4 flex justify-between items-center shadow-sm">
                <div><h2 class="text-xs font-bold text-blue-400 mb-1 uppercase tracking-wider">ğŸ‡¯ğŸ‡µ å…¬æ¬¾æ—¥å¹£é¤˜é¡</h2><div class="text-2xl font-black text-blue-800 tracking-tight">Â¥<span id="public-balance">0</span></div><div class="text-[10px] text-gray-400 mt-1 flex gap-2"><span>å¹³å‡åŒ¯ç‡: <span id="avg-rate-display">--</span></span><span class="text-blue-400 font-medium">(ç´„ NT$<span id="public-balance-twd">0</span>)</span></div></div>
                <button onclick="toggleExchangeModal()" class="bg-white border border-blue-200 text-blue-600 text-xs px-3 py-2 rounded-lg font-bold shadow-sm active:scale-95 hover:bg-blue-50 transition-colors flex flex-col items-center"><span class="text-lg mb-0.5">ğŸ’±</span><span>æ›åŒ¯</span></button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-4">
                <div class="flex justify-between items-center mb-1"><p class="text-xs text-gray-500 font-bold">ç¸½æ”¯å‡º (æ›ç®—å°å¹£)</p><div class="flex gap-2"><button onclick="toggleSettlement()" class="text-[10px] text-orange-600 font-bold bg-orange-50 px-2 py-1 rounded-full border border-orange-200 flex items-center gap-1">ğŸ’° çµç®— <svg id="arrow-settlement" class="w-3 h-3 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><button onclick="fetchData()" class="text-[10px] text-cyan-600 font-bold bg-cyan-50 px-2 py-1 rounded-full border border-cyan-200">â†» æ›´æ–°</button></div></div>
                <div class="flex justify-between items-end border-b border-gray-100 pb-4 mb-3"><p class="text-3xl font-black text-cyan-700" id="total-expense">0</p></div>
                <div id="settlement-content" class="bg-orange-50 border border-orange-100 p-3 rounded-lg text-sm text-orange-800 mt-2"><p class="font-bold mb-1">ğŸ’° çµç®—å»ºè­° (ä¸å«å…¬è²»)ï¼š</p><p id="settlement-text">è¨ˆç®—ä¸­...</p></div>
            </div>
            <div><h3 class="font-bold text-gray-700 mb-3 px-1">æ¶ˆè²»æ˜ç´°</h3><div id="expense-list" class="space-y-3 pb-10 text-center text-gray-400 text-sm">è¼‰å…¥ä¸­...</div></div>
        </div>
    </main>

    <div class="fixed bottom-24 right-5 z-40 flex flex-col gap-3">
        <button onclick="toggleTranslate()" class="bg-violet-600 hover:bg-violet-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95 border-2 border-white">
            <span class="text-2xl">ğŸ—£ï¸</span>
        </button>
        <button onclick="toggleCalc()" class="bg-pink-500 hover:bg-pink-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95 border-2 border-white">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
        </button>
    </div>

    <div id="translate-modal" class="fixed inset-0 z-[80] flex items-center justify-center px-4 modal hidden-modal">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleTranslate()"></div>
        <div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative z-10">
            <div class="bg-violet-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2">ğŸ‡¯ğŸ‡µ éš¨èº«ç¿»è­¯ (Gemini)</h3><button onclick="toggleTranslate()" class="text-white/80 hover:text-white">âœ•</button></div>
            <div class="p-6 flex flex-col items-center gap-4">
                <textarea id="trans-input" rows="3" class="w-full border border-gray-200 rounded-xl p-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="è¼¸å…¥æˆ–èªªè©± (ä¸­æ–‡)..."></textarea>
                
                <div class="flex w-full gap-2">
                    <button id="btn-mic" onclick="startDictation()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors">
                        <span class="text-xl">ğŸ¤</span> èªªè©±
                    </button>
                    <button onclick="doTranslate()" id="btn-trans-go" class="flex-[2] bg-violet-600 hover:bg-violet-700 text-white py-3 rounded-xl font-bold shadow-md transition-colors">
                        ç¿»è­¯æˆæ—¥æ–‡
                    </button>
                </div>

                <div class="w-full bg-violet-50 rounded-xl p-4 border border-violet-100 relative min-h-[5rem]">
                    <p id="trans-result" class="text-lg font-bold text-gray-800">...</p>
                    <button onclick="speakResult()" class="absolute bottom-2 right-2 text-violet-600 hover:bg-violet-100 p-2 rounded-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="exchange-modal" class="fixed inset-0 z-[70] flex items-center justify-center px-4 modal hidden-modal">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleExchangeModal()"></div>
        <div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative z-10">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2">ğŸ”„ æ–°å¢æ›åŒ¯ç´€éŒ„</h3><button onclick="toggleExchangeModal()" class="text-white/80 hover:text-white">âœ•</button></div>
            <div class="p-5 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label><input type="date" id="ex-date" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">èª°æ›çš„</label><select id="ex-who" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2"><option value="ç¿”">ç¿”</option><option value="å½¥">å½¥</option></select></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">å°å¹£æˆæœ¬ (TWD)</label><input type="number" id="ex-twd" placeholder="ä¾‹å¦‚ï¼š8500" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-lg font-bold text-gray-800"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">æ›å¾—æ—¥å¹£ (JPY)</label><input type="number" id="ex-jpy" placeholder="ä¾‹å¦‚ï¼š38636" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-lg font-bold text-gray-800"></div>
                <button onclick="submitExchange()" id="btn-submit-ex" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-md mt-2">ç¢ºèªæ–°å¢</button>
                <div class="mt-4 pt-4 border-t border-gray-100"><p class="text-xs font-bold text-gray-400 mb-2">æ›åŒ¯æ­·å²</p><div id="exchange-history" class="space-y-2 max-h-32 overflow-y-auto text-xs"></div></div>
            </div>
        </div>
    </div>

    <div id="calc-modal" class="fixed inset-0 z-[70] flex items-center justify-center px-4 modal hidden-modal">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleCalc()"></div>
        <div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative z-10">
            <div class="bg-cyan-600 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2">ğŸ’± åŒ¯ç‡æ›ç®—</h3><button onclick="toggleCalc()" class="text-white/80 hover:text-white">âœ•</button></div>
            <div class="p-6 space-y-6">
                <div class="text-center text-sm text-gray-500 mb-2">ç•¶å‰å¹³å‡åŒ¯ç‡ï¼š1 JPY â‰ˆ <span id="display-rate" class="font-bold text-cyan-600 text-lg">--</span> TWD</div>
                <div class="space-y-4">
                    <div class="relative"><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ğŸ‡¯ğŸ‡µ æ—¥å¹£ (JPY)</label><input type="number" id="input-jpy" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-lg font-bold text-gray-800"></div>
                    <div class="relative"><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ğŸ‡¹ğŸ‡¼ æ–°å°å¹£ (TWD)</label><input type="number" id="input-twd" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-lg font-bold text-gray-800"></div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bg-white border-t border-gray-200 shrink-0 pb-safe z-50 fixed bottom-0 w-full max-w-md">
        <div class="grid grid-cols-5 h-16">
            <button onclick="switchTab('itinerary')" id="btn-itinerary" class="nav-btn flex flex-col items-center justify-center w-full h-full text-cyan-600"><span class="text-xl">ğŸ“…</span><span class="text-[10px] font-medium mt-1">è¡Œç¨‹</span></button>
            <button onclick="switchTab('flights')" id="btn-flights" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400"><span class="text-xl">âœˆï¸</span><span class="text-[10px] font-medium mt-1">ç­æ©Ÿ</span></button>
            <button onclick="switchTab('hotels')" id="btn-hotels" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400"><span class="text-xl">ğŸ¨</span><span class="text-[10px] font-medium mt-1">ä½å®¿</span></button>
            <button onclick="switchTab('mustbuy')" id="btn-mustbuy" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400"><span class="text-xl">ğŸ›ï¸</span><span class="text-[10px] font-medium mt-1">å¿…è²·</span></button>
            <button onclick="switchTab('accounting')" id="btn-accounting" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400"><span class="text-xl">ğŸ’°</span><span class="text-[10px] font-medium mt-1">åˆ†å¸³</span></button>
        </div>
    </nav>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwWDFDAIXgnW_CUIz0RDuMIgZC77rbzo3BwVy4FOVOXnsmoXBhzVEc3AZ-0AM3YPrSQ/exec";

        const DATA = {
            days: [ { day: 1, date: "2/8 (æ—¥)", title: "æŠµé” & é‚£éœ¸" }, { day: 2, date: "2/9 (ä¸€)", title: "ç§Ÿè»Š & åè­·" }, { day: 3, date: "2/10 (äºŒ)", title: "æ°´æ—é¤¨ & å¤å®‡åˆ©" }, { day: 4, date: "2/11 (ä¸‰)", title: "å—éƒ¨ & æ²–ç¹©ä¸–ç•Œ" }, { day: 5, date: "2/12 (å››)", title: "ä¸­éƒ¨ & ç¾åœ‹æ‘" }, { day: 6, date: "2/13 (äº”)", title: "å¸‚å€ & è³¼ç‰©" }, { day: 7, date: "2/14 (å…­)", title: "ç€¨é•·å³¶ & åœ‹éš›é€š" }, { day: 8, date: "2/15 (æ—¥)", title: "é‚„è»Š & è¿”å°" } ],
            flights: [ { type: "å»ç¨‹", date: "2/8 (æ—¥)", airline: "æ³°è¶Šæ· VZ568", time: "14:45 - 17:05", from: "æ¡ƒåœ’ T1", to: "é‚£éœ¸", note: "é è¨ˆ 17:05 æŠµé”" }, { type: "å›ç¨‹", date: "2/15 (æ—¥)", airline: "è¯èˆª CI121", time: "11:55 - 12:35", from: "é‚£éœ¸", to: "æ¡ƒåœ’ T2", note: "09:30 è¾¦ç†ç™»æ©Ÿ" } ],
            hotels: [ { name: "é‚£éœ¸å°ç¥¿ç«™å‰ysæ—…é¤¨", dates: "2/8 - 2/9 (1æ™š)", location: "é‚£éœ¸å°ç¥¿", note: "å–®è»Œå°ç¥¿ç«™æ—ï¼ŒCheck-in 18:05å¾Œ", mapLink: "https://www.google.com/maps/search/?api=1&query=Ys+Inn+Naha+Oroku", checkIn: "15:00", checkOut: "12:00" }, { name: "ãƒ›ãƒ†ãƒ«ãƒªã‚¾ãƒãƒƒã‚¯ã‚¹åè­·", dates: "2/9 - 2/10 (1æ™š)", location: "åè­·", note: "Resonex Nagoï¼Œç§äººæ²™ç˜ï¼Œæ‰€æœ‰æˆ¿é–“é¢æµ·ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=Hotel+Resonex+Nago", checkIn: "15:00", checkOut: "11:00" }, { name: "åˆ»ã®å®¿ é‚£è¦‡", dates: "2/10 - 2/15 (5æ™š)", location: "é‚£éœ¸", note: "é€£ä½5æ™šï¼Œå«ç°¡æ˜“å»šæˆ¿ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=Toki+no+Yado+Naha", checkIn: "15:00", checkOut: "10:00" } ],
            shopping: [ { name: "ç´…èŠ‹å¡” (Beni Imo Tart)", desc: "æ²–ç¹©æœ€ç¶“å…¸ä¼´æ‰‹ç¦®ï¼Œå¾¡è“å­å¾¡æ®¿å¿…è²·ã€‚", highlight: "ç¶“å…¸å¿…è²·" }, { name: "é‡‘æ¥šç³• (Chinsuko)", desc: "ç‰çƒå‚³çµ±é¤…ä¹¾ï¼Œå£æ„Ÿé…¥è„†ï¼Œé¹½å‘³æœ€å—æ­¡è¿ã€‚", highlight: "å‚³çµ±é»å¿ƒ" }, { name: "æ²–ç¹©è¦é¤…", desc: "è¾£å‘³è¦é¤…ï¼Œéå¸¸æ¶®å˜´ï¼Œé©åˆç•¶ä¸‹é…’èœã€‚", highlight: "äººæ°£é›¶é£Ÿ" }, { name: "Fukugiya å¹´è¼ªè›‹ç³•", desc: "åœ‹éš›é€šååº—ï¼Œèœ‚èœœå’Œé»‘ç³–å£å‘³éƒ½å¾ˆæ£’ã€‚", highlight: "æ’éšŠç¾é£Ÿ" } ],
            activities: [
                { dayId: 1, time: "11:00", title: "ğŸš— é–‹è»Šå»åœè»Šå ´", desc: "<a href='https://maps.app.goo.gl/DAcNG4NwXqRsg7qTA' target='_blank'>Times å¤§åœ’é«˜éµåŒ—è·¯äºŒæ®µåœè»Šå ´</a> (åœè»Š1å¤©100å…ƒï¼Œè½‰æ·é‹é ˜èˆªç«™)", type: "transport" },
                { dayId: 1, time: "11:30", title: "ğŸ›« è¾¦ç†ç™»æ©Ÿæ‰‹çºŒ", desc: "æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ (é ˜èˆªç«™-æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆç«™)", type: "transport" },
                { dayId: 1, time: "14:45", title: "âœˆï¸ é£›æ©Ÿèµ·é£›", desc: "æ³°åœ‹è¶Šæ·èˆªç©º VZ568ï¼Œé è¨ˆ 17:05 æŠµé”", type: "flight" },
                { dayId: 1, time: "17:05", title: "ğŸ›¬ å‡ºé—œ", desc: "é‚£éœ¸æ©Ÿå ´ <a href='https://www.facebook.com/share/r/17zbjUwdwr/?mibextid=wwXIfr' target='_blank' class='text-blue-600 underline'>æ©Ÿå ´ç‚¸åˆé¤è‚‰FBä»‹ç´¹</a>", type: "activity" },
                { dayId: 1, time: "18:05", title: "ğŸš† æ­ä¹˜å–®è»Œå‰å¾€é£¯åº—", desc: "å‰å¾€ <a href='https://maps.app.goo.gl/vPCJDYhioHijR7476' target='_blank'>é‚£éœ¸å°ç¥¿ç«™å‰ysæ—…é¤¨</a> Check in", type: "transport" },
                { dayId: 1, time: "18:40", title: "ğŸœ æ™šé¤ï¼šç‰çƒæ–°éºµ é€šå ‚", desc: "<a href='https://maps.app.goo.gl/JSpG8bYnT7qVM6oh6' target='_blank'>é€šå ‚ å°ç¥¿æœ¬åº—</a> (ç”·äººéºµ/å¥³äººéºµ)", type: "food" },
                { dayId: 1, time: "19:40", title: "ğŸ›’ æ™šé¤ã€è¶…å¸‚æ¡è²·", desc: "<a href='https://maps.app.goo.gl/3St2Kjgai1WesYdv8' target='_blank'>æ°¸æ—º é‚£éœ¸åº— (Aeon Naha)</a> æ™šé¤ã€éš¨æ„é€›é€›", type: "shopping" },
                { dayId: 1, time: "21:00", title: "ğŸ¨ ä½å®¿ï¼šé‚£éœ¸å°ç¥¿ç«™å‰ysæ—…é¤¨", desc: "é€€æˆ¿æ™‚é–“ç‚º12:00", type: "hotel" },
                { dayId: 2, time: "10:00", title: "ğŸ” æ—©åˆé¤ï¼šA&W æ¼¢å ¡", desc: "<a href='https://www.google.com/maps/search/?api=1&query=A%26W+Naha+Kanagusuku' target='_blank'>A&W Naha Kanagusuku</a> æˆ– <a href='https://www.google.com/maps/search/?api=1&query=Aeon+Naha' target='_blank'>Aeon Naha</a> (ç¶“å…¸ Root Beer)", type: "food" },
                { dayId: 2, time: "12:00", title: "ğŸš† å‰å¾€ç§Ÿè»Šè¡Œ", desc: "å–®è»Œï¼š<a href='https://maps.app.goo.gl/1JoXTvGk3KzBkYby9' target='_blank'>èµ¤å¶ºç«™ (åŒ—å£)</a> æ­ä¹˜æ¥é§è»Š", type: "transport" },
                { dayId: 2, time: "12:30", title: "ğŸš— å–è»Š (å¤§æ¦®ç§Ÿè»Š)", desc: "å¤§æ¦®ç§Ÿè»Š<br><b>ğŸ“¹ <a href='https://www.youtube.com/watch?v=tDy2CliwKS4' target='_blank' class='text-blue-600 underline'>å–®è»Œèµ¤å¶ºç«™ 12:30 æ¥é§æ–¹æ³•</a></b><br>è»Šæ¬¾ï¼šToyota Yaris<br>è²»ç”¨ï¼šNT$8,400 (ç¾å ´æ”¯ä»˜/æœªå«ä¿éšª)<br>å–®è™Ÿï¼šN0209-0215RC4-08<br>è¨‚è³¼äººï¼šå¾å•Ÿç¿” / 0918-563-811<br><span style='color:#e74c3c; font-weight:bold;'>âš ï¸ è¨˜å¾—å‘ŠçŸ¥ï¼š2/15(æ—¥) 09:30 è¦æ­æ¥é§å»æ©Ÿå ´</span>", type: "transport", tag: "ç§Ÿè»Š" },
                { dayId: 2, time: "13:40", title: "ğŸ¦ åˆé¤ï¼šæµ·é®®åƒçˆ†", desc: "<a href='https://maps.app.goo.gl/VHzgnj1RH9PrVduw8' target='_blank'>ç³»æ»¿é­šå¸‚å ´</a> (æ¨è–¦ç”Ÿé­šç‰‡ã€ç„—çƒ¤é¾è¦) è»Šç¨‹ç´„5åˆ†", type: "food" },
                { dayId: 2, time: "15:50", title: "ğŸŒŠ è¬åº§æ¯›", desc: "<a href='https://maps.app.goo.gl/1qQWKJXqCXNiG3hL8' target='_blank'>è¬åº§æ¯› (è±¡é¼»å²©æ™¯è§€)</a> è»Šç¨‹ç´„80åˆ†", type: "activity" },
                { dayId: 2, time: "17:00", title: "ğŸ« è²·ç¥¨ & ä¼‘æ¯", desc: "<a href='https://maps.app.goo.gl/MPncpEnoHprksy1h7' target='_blank'>è¨±ç”°ä¼‘æ¯ç«™</a> (è»Šç¨‹ç´„30åˆ†)<br><span style='color:#e74c3c; font-weight:bold;'>âš ï¸ è²·æ°´æ—é¤¨é–€ç¥¨</span>ã€<a href='https://www.facebook.com/share/r/183t8dtLbg/?mibextid=wwXIfr' target='_blank' class='text-blue-600 underline'>åƒç‚¸ç‰©</a>", type: "activity" },
                { dayId: 2, time: "17:55", title: "ğŸ¨ é£¯åº— Check-in", desc: "<a href='https://maps.app.goo.gl/nbq8cNbLN9xJVUA98' target='_blank'>ãƒ›ãƒ†ãƒ«ãƒªã‚¾ãƒãƒƒã‚¯ã‚¹åè­·</a> (ç§äººæµ·ç˜æ•£æ­¥ã€å¤•é™½å¾ˆç¾)", type: "hotel" },
                { dayId: 2, time: "18:30", title: "ğŸ¥© æ™šé¤ï¼šç‡’è‚‰äº”è‹‘", desc: "<a href='https://maps.app.goo.gl/zvE1ahjbgmokVTaY6' target='_blank'>ç‡’è‚‰äº”è‹‘åè­·åº—</a> (å·²é ç´„ 18:30 2ä½ï¼Œå¯é †é€›éš”å£<a href='https://maps.app.goo.gl/PchKk1p2wReoJpsu8' target='_blank'>æ¼«ç•«å€‰åº«</a>)", type: "food", important: true },
                { dayId: 2, time: "20:40", title: "ğŸ¨ ä½å®¿ï¼šåè­· Resonex Nago", desc: "éš”å¤©æœ‰é£¯åº—æ—©é¤", type: "hotel" },
                { dayId: 3, time: "08:30", title: "ğŸ¥£ æ—©é¤", desc: "ãƒ›ãƒ†ãƒ«ãƒªã‚¾ãƒãƒƒã‚¯ã‚¹åè­· (é£¯åº—æ—©é¤)", type: "food" },
                { dayId: 3, time: "10:00", title: "ğŸ¦ˆ ç¾éº—æµ·æ°´æ—é¤¨", desc: "<a href='https://maps.app.goo.gl/dbvaQEXwrBiSA7ST9' target='_blank'>ç¾éº—æµ·æ°´æ—é¤¨ (é»‘æ½®ä¹‹æµ·)</a> è»Šç¨‹ç´„25åˆ†", type: "activity", important: true },
                { dayId: 3, time: "14:10", title: "ğŸ½ï¸ åˆé¤ï¼šæµ·æ™¯é¤å»³", desc: "L LOTA (å¤å®‡åˆ©å³¶) è»Šç¨‹ç´„35åˆ†", type: "food" },
                { dayId: 3, time: "15:00", title: "ğŸï¸ å¤å®‡åˆ©å³¶å·¡ç¦®", desc: "<a href='https://www.google.com/maps/search/?api=1&query=å¿ƒå½¢å²©' target='_blank'>å¿ƒå½¢å²©</a>ã€<a href='https://www.google.com/maps/search/?api=1&query=å¤å®‡åˆ©æµ·æ´‹å¡”-åœè»Šå ´' target='_blank'>å¤å®‡åˆ©æµ·æ´‹å¡”-åœè»Šå ´</a> (æ²™ç˜ã€æ©‹é ­æ‹ç…§)", type: "activity" },
                { dayId: 3, time: "18:00", title: "â˜• æ™šé¤ / ä¸‹åˆèŒ¶", desc: "<a href='https://maps.app.goo.gl/MDAAH3BqAyj3VXZE7' target='_blank'>BANTA CAFE</a> (çœ‹å¤œæ™¯) <a href='https://www.facebook.com/share/r/1U1gyWhzTa/?mibextid=wwXIfr' target='_blank' class='text-blue-600 underline'>FBä»‹ç´¹</a> (å›ç¨‹è¼ƒé ï¼Œé æŠ“1.5hr)", type: "food" },
                { dayId: 3, time: "20:20", title: "ğŸ¨ é£¯åº— Check-in", desc: "åˆ»ã®å®¿ é‚£è¦‡ (åœè»Šï¼š<a href='https://maps.app.goo.gl/wsbADdeUuLNcfMA27' target='_blank'>æ²–ç¸„çœŒæ¨‹å·ç«‹ä½“é§è»Šå ´</a>) å…¥ä½ä»£ç¢¼ï¼š733562ã€è²·éš”å¤©æ—©é¤", type: "hotel" },
                { dayId: 4, time: "09:00", title: "ğŸ¥£ æ—©é¤", desc: "<a href='https://maps.app.goo.gl/V5kaFqD58e2bE7Sv8' target='_blank'>åˆ»ã®å®¿ é‚£è¦‡</a>", type: "food" },
                { dayId: 4, time: "09:50", title: "ğŸ° å¤è¹Ÿå·¡ç¦®", desc: "<a href='https://maps.app.goo.gl/DztRTHkY4sjzMtUJ8' target='_blank'>é¦–é‡ŒåŸå…¬åœ’</a> (è»Šç¨‹ç´„20åˆ†)", type: "activity" },
                { dayId: 4, time: "11:50", title: "ğŸ½ï¸ åˆé¤", desc: "æ°¸æ—ºåŸ å—åŸå¤§é‡Œ (è»Šç¨‹ç´„30åˆ†)", type: "food" },
                { dayId: 4, time: "13:00", title: "ğŸ‘¹ æ²–ç¹©ä¸–ç•Œæ–‡åŒ–ç‹åœ‹", desc: "<a href='https://maps.app.goo.gl/tmqeh6zTEGffPFcs5' target='_blank'>æ²–ç¹©ä¸–ç•Œåœè»Šå ´</a> (ç‰æ³‰æ´ã€ç‹åœ‹æ‘ï¼›14:30 å¤ªé¼“èˆç§€ã€æ³¢ä¼¯è›‡åœ’)", type: "activity" },
                { dayId: 4, time: "16:00", title: "ğŸ›’ å¥½å¸‚å¤šæ¡è³¼", desc: "<a href='https://maps.app.goo.gl/giC5VC7dKfwGsGzCA' target='_blank'>Costco æ²–ç¹©å—åŸå€‰åº«åº—</a> (è²·è‰è“ï¼)", type: "shopping" },
                { dayId: 4, time: "17:50", title: "ğŸ‘• æ©Ÿèƒ½æœé£¾", desc: "<a href='https://maps.app.goo.gl/FXV6h1UZdMyiwVYw6' target='_blank'>WORKMAN Yaese</a>", type: "shopping" },
                { dayId: 4, time: "19:05", title: "ğŸ› æ™šé¤ï¼šå’–å“©é£¯", desc: "<a href='https://maps.app.goo.gl/GxUUMn6ff7XAX2KR8' target='_blank'>CoCo Ichibanya Round 1 å—é¢¨åŸåº—</a>", type: "food" },
                { dayId: 4, time: "20:30", title: "ğŸ¨ è¿”å›ä½å®¿", desc: "<a href='https://maps.app.goo.gl/V5kaFqD58e2bE7Sv8' target='_blank'>åˆ»ã®å®¿ é‚£è¦‡</a> (<a href='https://maps.app.goo.gl/wsbADdeUuLNcfMA27' target='_blank'>æ²–ç¸„çœŒæ¨‹å·ç«‹ä½“é§è»Šå ´</a>)", type: "hotel" },
                { dayId: 5, time: "08:30", title: "ğŸœ æ—©é¤ï¼šæ²–ç¹©éºµ", desc: "<a href='https://maps.app.goo.gl/zbk64W2Ut8ctUWN39' target='_blank'>STAND EIBUN</a> (æ­¥è¡Œ4åˆ†é˜ã€‚å¿…é»ï¼šäºç‘Ÿéºµ Arthur Sobaã€å’–å“©éºµ)", type: "food" },
                { dayId: 5, time: "10:40", title: "ğŸš— çµ•æ™¯å…œé¢¨", desc: "<a href='https://maps.app.goo.gl/8Pzgtt32syLyKvKq5' target='_blank'>æµ·ä¸­é“è·¯</a> & <a href='https://maps.app.goo.gl/kD8ek67V7KxdL1q96' target='_blank'>æœå ±æ‡¸å´–</a> (åƒè§€ <a href='https://maps.app.goo.gl/BXLSAdsQ2nfprgZj9' target='_blank'>å‘½å¾¡åº­è£½é¹½å·¥å» </a>)", type: "activity" },
                { dayId: 5, time: "12:10", title: "ğŸ™ é»å¿ƒï¼šç« é­šç‡’", desc: "<a href='https://maps.app.goo.gl/fPvsVg6RrdH3idhZ8' target='_blank'>æ²–ç¸„ã‚¤ã‚¤ãƒ€ã‚³å±‹å¤ªé™½</a> <a href='https://www.facebook.com/reel/1540297270440381' target='_blank' class='text-blue-600 underline'>FBé€£çµä»‹ç´¹</a>", type: "food" },
                { dayId: 5, time: "13:00", title: "ğŸ›ï¸ åˆé¤ & é€›è¡—", desc: "<a href='https://maps.app.goo.gl/zy6sQ5hfQgL2LMkc6' target='_blank'>æ°¸æ—ºå¤¢æ¨‚åŸä¾†å®¢å¤¢ Rycom</a> (Porteråœ¨SAC'S BAR Resort)", type: "shopping" },
                { dayId: 5, time: "17:00", title: "ğŸ‡ºğŸ‡¸ ç¾åœ‹æ‘ & æ™šé¤", desc: "ç¾åœ‹æ‘ American Village (åœè»Šï¼šåŒ—è°·ç”ºç‡Ÿæˆ– <a href='https://maps.app.goo.gl/Rj1LsEiXJLvg5hHo9' target='_blank'>Depot Island</a>ã€‚åƒï¼šTaco Rice Cafe, è±¬è‚‰è›‹é£¯ç³°)", type: "activity" },
                { dayId: 5, time: "21:00", title: "ğŸ¨ è¿”å›ä½å®¿", desc: "åˆ»ã®å®¿ é‚£è¦‡ (<a href='https://maps.app.goo.gl/wsbADdeUuLNcfMA27' target='_blank'>æ²–ç¸„çœŒæ¨‹å·ç«‹ä½“é§è»Šå ´</a>)", type: "hotel" },
                { dayId: 6, time: "09:30", title: "ğŸŒ¸ è³æ«»", desc: "<a href='https://maps.app.goo.gl/M8S9cDXHb62GqHJ28' target='_blank'>èˆ‡å„€å…¬åœ’</a> (æ­¥è¡Œ 6 åˆ†é˜)", type: "activity" },
                { dayId: 6, time: "10:15", title: "ğŸŸ æ—©é¤ï¼šæµ·é®®", desc: "<a href='https://maps.app.goo.gl/Z2Hd63ESntQ4dNAn8' target='_blank'>æ³Šæ¸¯æ¼å¸‚å ´</a> (è»Šç¨‹ç´„15åˆ†)", type: "food" },
                { dayId: 6, time: "11:30", title: "â›©ï¸ åƒæ‹œ", desc: "<a href='https://maps.app.goo.gl/K91cPBSJCRj8BWYE7' target='_blank'>æ³¢ä¸Šå®®</a> (åœé™„è¿‘ä»˜è²»åœè»Šå ´)", type: "activity" },
                { dayId: 6, time: "12:50", title: "ğŸ© ç”œé»", desc: "<a href='https://maps.app.goo.gl/VwbkZ7LAVcP9Bnw38' target='_blank'>Cream D Omoromachi</a> (ç”Ÿç”œç”œåœˆ) <a href='https://www.facebook.com/reel/845741431632238' target='_blank' class='text-blue-600 underline'>FBä»‹ç´¹</a>", type: "food" },
                { dayId: 6, time: "13:40", title: "ğŸ“¸ æ‹ç…§é€›è¡—", desc: "<a href='https://maps.app.goo.gl/yaNpUYjVEf5uJ6g9A' target='_blank'>æ¸¯å·å¤–äººä½å®…</a>", type: "activity" },
                { dayId: 6, time: "14:50", title: "ğŸ›ï¸ åˆé¤+è³¼ç‰©å¤§æˆ°", desc: "<a href='https://maps.app.goo.gl/hjxvWREbo3U2d4ky5' target='_blank'>PARCO CITY</a> (æ•˜æ•˜è‹‘3Fã€æ¼¢å ¡æ’2Fã€Porter 1F HANDSå…§ã€é³¥ç‰)", type: "shopping" },
                { dayId: 6, time: "19:45", title: "ğŸ‘Ÿ é‹å‹•ç”¨å“", desc: "<a href='https://maps.app.goo.gl/Tq8gR1DcAT4gxgX7A' target='_blank'>Sports Depo å¤©ä¹…åº—</a> (é‹å‹•é‹)", type: "shopping" },
                { dayId: 6, time: "21:00", title: "ğŸœ æ™šé¤ï¼šæ‹‰éºµ", desc: "<a href='https://maps.app.goo.gl/cp5a9u7DcSpHjWYBA' target='_blank'>çƒˆç«ãƒ©ãƒ¼ãƒ¡ãƒ³æš–æš®</a> (åœ¨è³¼ç‰©ä¸­å¿ƒåƒæˆ–é–‹è»Šå›å»åƒæ‹‰éºµ ç‡Ÿæ¥­åˆ°2:00a.m.)", type: "food" },
                { dayId: 7, time: "09:00", title: "ğŸ¥£ æ—©é¤ï¼šå¸‚å ´å·¡ç¦®", desc: "<a href='https://maps.app.goo.gl/AYwfA4LNNigJvAV78' target='_blank'>ç‰§å¿—å…¬è¨­å¸‚å ´</a> (æ­¥è¡Œ 10 åˆ†é˜)", type: "food" },
                { dayId: 7, time: "10:40", title: "âœˆï¸ çœ‹é£›æ©Ÿ/æµ·æ™¯", desc: "<a href='https://maps.app.goo.gl/KF5KNjECB1zjpcqo9' target='_blank'>ç€¨é•·å³¶ Umikaji Terrace</a>", type: "activity" },
                { dayId: 7, time: "12:00", title: "ğŸ›ï¸ Outlet è³¼ç‰© & åˆé¤", desc: "<a href='https://maps.app.goo.gl/53Hpyq3h2Xz1HZ7d6' target='_blank'>Ashibinaa Outlet</a> (iias æ²–ç¹©è±å´)<br>é€›ï¼šBEAMS, United Arrows, Porter (GRAN SAC'S)<br>åˆé¤ï¼š<a href='https://maps.app.goo.gl/JYRLNqQSZE9YqGxQ8' target='_blank'>æ²–ç¹©èœåœ’ Karakara</a> <a href='https://www.facebook.com/reel/1424317575868459' target='_blank' class='text-blue-600 underline'>FBä»‹ç´¹</a>", type: "shopping" },
                { dayId: 7, time: "17:45", title: "ğŸŒƒ åœ‹éš›é€š", desc: "è»Šå…ˆåœå›<a href='https://maps.app.goo.gl/pKdmCGuYChxP3R8R8' target='_blank'>åœè»Šå ´</a>ã€‚<br>æ™šé¤ï¼š<a href='https://maps.app.goo.gl/yyxXqMyGrGqCKntVA' target='_blank'>é˜¿å¤è±¬ç«é‹ (TRITON)</a> æˆ– <a href='https://www.facebook.com/share/r/17mmY4VG4P/?mibextid=wwXIfr' target='_blank' class='text-blue-600 underline'>æ²–ç¸„æ–™ç†å±…é…’å±‹ ã¶ã£ãŸ</a>", type: "activity" },
                { dayId: 7, time: "21:00", title: "ğŸ¨ è¿”å›ä½å®¿", desc: "<a href='https://maps.app.goo.gl/V5kaFqD58e2bE7Sv8' target='_blank'>åˆ»ã®å®¿ é‚£è¦‡</a> (æ”¶è¡Œæ) (<a href='https://maps.app.goo.gl/wsbADdeUuLNcfMA27' target='_blank'>æ²–ç¸„çœŒæ¨‹å·ç«‹ä½“é§è»Šå ´</a>)", type: "hotel" },
                { dayId: 8, time: "07:30", title: "ğŸ¥£ æ—©é¤ / é€€æˆ¿", desc: "åˆ»ã®å®¿ é‚£è¦‡ (æª¢æŸ¥è¡Œæ)", type: "food" },
                { dayId: 8, time: "08:00", title: "ğŸš— å‰å¾€å¤§æ¦®ç§Ÿè»Š", desc: "<a href='https://maps.app.goo.gl/pd7XDm9EWGM1LQvx7' target='_blank'>å¤§æ¦®ç§Ÿè»Š</a> (åŠ æ²¹ & é‚„è»Š)", type: "transport" },
                { dayId: 8, time: "09:30", title: "ğŸ›« è¾¦ç†ç™»æ©Ÿæ‰‹çºŒ", desc: "é‚£éœ¸æ©Ÿå ´åœ‹éš›ç·šèˆªå»ˆ (æ­ä¹˜æ¥é§è»Š)", type: "transport" },
                { dayId: 8, time: "11:55", title: "âœˆï¸ é£›æ©Ÿèµ·é£›", desc: "è¯èˆª CI121 (æŠµé”æ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ)", type: "flight" }
            ]
        };

        // ... ä»¥ä¸‹ç‚ºç›¸åŒçš„é‚è¼¯ç¨‹å¼ç¢¼ ...
        let currentDayId = 1;
        let AVG_RATE = 0.22;

        window.addEventListener('DOMContentLoaded', () => {
            renderDaySelector();
            renderItinerary(currentDayId);
            renderFlights();
            renderHotels();
            renderMustBuy();
            
            document.getElementById('acc-date').valueAsDate = new Date("2026-02-08");
            document.getElementById('ex-date').valueAsDate = new Date();
            document.getElementById('acc-custom-rate').value = AVG_RATE;
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-cyan-600');
                btn.classList.add('text-gray-400');
            });
            document.getElementById(`btn-${tabName}`).classList.remove('text-gray-400');
            document.getElementById(`btn-${tabName}`).classList.add('text-cyan-600');

            if(tabName === 'accounting') fetchData();
        }

        // --- è¡Œç¨‹ç›¸é—œåŠŸèƒ½ ---
        function selectDay(dayId) { currentDayId = dayId; renderDaySelector(); renderItinerary(dayId); document.getElementById('app-container').scrollTo({ top: 0, behavior: 'smooth' }); }
        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = DATA.days.map(d => {
                const isActive = d.day === currentDayId;
                const activeClass = isActive ? 'bg-cyan-600 text-white shadow-md transform scale-105' : 'bg-white text-gray-500 border border-gray-100';
                return `<button onclick="selectDay(${d.day})" class="flex-none flex flex-col items-center justify-center min-w-[3.8rem] py-2 rounded-xl transition-all duration-200 ${activeClass}">
                        <span class="text-[10px] font-medium opacity-90">Day ${d.day}</span>
                        <span class="text-sm font-bold">${d.date.split('(')[0]}</span>
                    </button>`;
            }).join('');
        }
        function renderItinerary(dayId) {
            const list = document.getElementById('itinerary-list');
            const dayData = DATA.days.find(d => d.day === dayId);
            const items = DATA.activities.filter(a => a.dayId === dayId);
            let html = `<div class="mb-4 px-1"><h2 class="text-2xl font-bold text-gray-800">${dayData.title}</h2><p class="text-sm text-gray-500 mt-1">${dayData.date}</p></div>`;
            if (items.length === 0) html += `<div class="p-8 text-center text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">æœ¬æ—¥ç„¡ç‰¹å®šè¡Œç¨‹</div>`;
            else {
                html += items.map((item, index) => {
                    const isLast = index === items.length - 1;
                    const typeColor = getTypeColor(item.type);
                    const typeIcon = getTypeIcon(item.type);
                    return `<div class="relative pl-4">${!isLast ? '<div class="timeline-line"></div>' : ''}<div class="relative bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-5 ${item.important ? 'border-l-4 border-l-red-400' : ''}"><div class="p-4 flex gap-4" onclick="toggleDesc(this)"><div class="flex flex-col items-center gap-1 min-w-[3.5rem] pt-1"><span class="text-sm font-black text-gray-700 tracking-tight">${item.time}</span><div class="w-9 h-9 rounded-full flex items-center justify-center text-white shadow-md z-10" style="background-color: ${typeColor}">${typeIcon}</div></div><div class="flex-1 min-w-0 pt-1"><h3 class="text-lg font-bold text-gray-800 leading-snug">${item.title}</h3><div class="mt-1 text-sm text-gray-600 desc-text leading-relaxed">${item.desc}</div>${item.tag ? `<span class="inline-block bg-blue-50 text-blue-600 text-[10px] px-2 py-0.5 rounded mt-1 font-bold">${item.tag}</span>` : ''}</div></div></div></div>`;
                }).join('');
            }
            list.innerHTML = html;
        }
        function renderFlights() { document.getElementById('view-flights').innerHTML = DATA.flights.map(f => `<div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative overflow-hidden mb-4"><div class="absolute top-0 right-0 bg-blue-600 text-white text-xs px-3 py-1 rounded-bl-lg font-bold">${f.type}</div><div class="flex justify-between items-center mb-4 mt-2"><div class="text-center"><div class="text-3xl font-black text-gray-800">${f.time.split('-')[0].trim()}</div><div class="text-xs text-gray-500 mt-1">${f.from}</div></div><div class="flex-1 flex flex-col items-center px-4"><div class="text-xs text-blue-600 font-bold mb-1">${f.airline}</div><div class="w-full h-[1px] bg-gray-300"></div></div><div class="text-center"><div class="text-3xl font-black text-gray-800">${f.time.split('-')[1].trim()}</div><div class="text-xs text-gray-500 mt-1">${f.to}</div></div></div><div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-800 border border-blue-100">${f.note}</div></div>`).join(''); }
        function renderHotels() { document.getElementById('view-hotels').innerHTML = DATA.hotels.map(h => `<div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 mb-4"><div class="flex justify-between items-start mb-3"><span class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded">${h.location}</span><span class="text-xs text-gray-400 font-medium">${h.dates}</span></div><h3 class="text-xl font-bold text-gray-800 mb-2">${h.name}</h3><div class="text-sm text-gray-600 p-3 rounded border border-gray-100 mb-4">${h.note}</div><a href="${h.mapLink}" target="_blank" class="block text-center bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl text-sm font-medium transition-colors">ğŸ“ æŸ¥çœ‹åœ°åœ–</a></div>`).join(''); }
        function renderMustBuy() { document.getElementById('mustbuy-list').innerHTML = DATA.shopping.map(item => `<div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex justify-between items-start"><div><h3 class="text-lg font-bold text-blue-800">${item.name}</h3><p class="text-sm text-gray-600 mt-1">${item.desc}</p></div><span class="bg-rose-100 text-rose-600 text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap ml-2">${item.highlight}</span></div>`).join(''); }
        function toggleDesc(el) { const desc = el.querySelector('.desc-text'); if(desc) desc.classList.toggle('expanded'); }
        function getTypeColor(type) { switch(type) { case 'transport': return '#06b6d4'; case 'flight': return '#2563eb'; case 'hotel': return '#a855f7'; case 'food': return '#f97316'; case 'shopping': return '#ec4899'; default: return '#10b981'; } }
        function getTypeIcon(type) { const icons = { transport: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>', flight: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>', hotel: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m8-2a2 2 0 100-4 2 2 0 000 4zm-6-4a2 2 0 110-4 2 2 0 010 4zm6-10a2 2 0 110-4 2 2 0 010 4zm-6 4a2 2 0 110-4 2 2 0 010 4z"></path></svg>', food: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>', shopping: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>' }; return icons[type] || icons.transport; }

        // --- ç¿»è­¯æ©Ÿé‚è¼¯ ---
        function toggleTranslate() {
            const modal = document.getElementById('translate-modal');
            modal.classList.toggle('hidden-modal');
            modal.classList.toggle('show-modal');
        }

        // èªéŸ³è¾¨è­˜ (Web Speech API)
        function startDictation() {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-TW'; // è¾¨è­˜ä¸­æ–‡
                recognition.continuous = false;
                recognition.interimResults = false;

                const btnMic = document.getElementById('btn-mic');
                btnMic.innerHTML = '<div class="recording-pulse w-4 h-4 bg-red-500 rounded-full"></div> è½å¯«ä¸­...';
                
                recognition.onresult = function(event) {
                    const text = event.results[0][0].transcript;
                    document.getElementById('trans-input').value = text;
                    btnMic.innerHTML = '<span class="text-xl">ğŸ¤</span> èªªè©±';
                };

                recognition.onerror = function(event) {
                    alert('èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼Œè«‹æ‰‹å‹•è¼¸å…¥');
                    btnMic.innerHTML = '<span class="text-xl">ğŸ¤</span> èªªè©±';
                };

                recognition.onend = function() {
                    btnMic.innerHTML = '<span class="text-xl">ğŸ¤</span> èªªè©±';
                };

                recognition.start();
            } else {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜');
            }
        }

        // å‘¼å« GAS é€²è¡Œç¿»è­¯
        async function doTranslate() {
            const text = document.getElementById('trans-input').value;
            if (!text) return;

            const btn = document.getElementById('btn-trans-go');
            const resultArea = document.getElementById('trans-result');
            
            btn.disabled = true;
            btn.innerText = "ç¿»è­¯ä¸­...";
            resultArea.innerText = "...";

            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'translate', text: text })
                });
                const data = await res.json();
                
                if (data.result === 'success') {
                    resultArea.innerText = data.text;
                } else {
                    resultArea.innerText = "ç¿»è­¯å¤±æ•—: " + data.msg;
                }
            } catch (err) {
                resultArea.innerText = "é€£ç·šéŒ¯èª¤";
            } finally {
                btn.disabled = false;
                btn.innerText = "ç¿»è­¯æˆæ—¥æ–‡";
            }
        }

        // æœ—è®€æ—¥æ–‡
        function speakResult() {
            const text = document.getElementById('trans-result').innerText;
            if (!text || text === '...') return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            window.speechSynthesis.speak(utterance);
        }

        // --- è¨˜å¸³èˆ‡æ›åŒ¯é‚è¼¯ (ä¸è®Š) ---
        function toggleExchangeModal() {
            const modal = document.getElementById('exchange-modal');
            modal.classList.toggle('hidden-modal');
            modal.classList.toggle('show-modal');
        }

        function toggleSettlement() {
            const content = document.getElementById('settlement-content');
            const arrow = document.getElementById('arrow-settlement');
            content.classList.toggle('open');
            arrow.classList.toggle('rotate');
        }

        async function submitExchange() {
            const btn = document.getElementById('btn-submit-ex');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "è™•ç†ä¸­...";

            const payload = {
                action: 'add_exchange',
                date: document.getElementById('ex-date').value,
                who: document.getElementById('ex-who').value,
                twd: document.getElementById('ex-twd').value,
                jpy: document.getElementById('ex-jpy').value
            };

            try {
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("âœ… æ›åŒ¯ç´€éŒ„æˆåŠŸï¼");
                toggleExchangeModal();
                fetchData();
            } catch (err) {
                alert("âŒ é€£ç·šå¤±æ•—");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        function updateRateInputLogic() {
            const currency = document.getElementById('acc-currency').value;
            const payer = document.getElementById('acc-payer').value;
            const rateArea = document.getElementById('rate-display-area');
            const rateInput = document.getElementById('acc-custom-rate');

            if (currency === 'JPY') {
                rateArea.classList.remove('hidden');
                if (payer.includes('å…¬è²»')) {
                    rateInput.value = AVG_RATE.toFixed(4);
                    rateInput.disabled = true;
                    rateInput.classList.add('text-gray-400');
                    rateInput.classList.remove('text-cyan-600');
                } else {
                    if(rateInput.disabled || rateInput.value === '') {
                         rateInput.value = AVG_RATE.toFixed(4);
                    }
                    rateInput.disabled = false;
                    rateInput.classList.remove('text-gray-400');
                    rateInput.classList.add('text-cyan-600');
                }
            } else {
                rateArea.classList.add('hidden');
            }
        }

        async function submitExpense(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit-acc');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'è™•ç†ä¸­...';

            const payload = {
                action: document.getElementById('edit-row-id').value ? 'edit_expense' : 'add_expense',
                row: document.getElementById('edit-row-id').value,
                date: document.getElementById('acc-date').value,
                payer: document.getElementById('acc-payer').value,
                item: document.getElementById('acc-item').value,
                currency: document.getElementById('acc-currency').value,
                amount: document.getElementById('acc-amount').value,
                rate: document.getElementById('acc-custom-rate').value || AVG_RATE, 
                note: document.getElementById('acc-note').value
            };

            try {
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert('âœ… è¨˜å¸³æˆåŠŸï¼');
                resetFormState();
                fetchData();
            } catch (err) {
                alert("âŒ é€£ç·šå¤±æ•—");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function fetchData() {
            const listDiv = document.getElementById('expense-list');
            const totalEl = document.getElementById('total-expense');
            const loadingMsg = document.getElementById('loading-msg');
            loadingMsg.classList.remove('hidden');
            listDiv.style.opacity = '0.5';

            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                
                if (data.error) {
                    listDiv.innerHTML = `<div class="text-center text-red-400 py-4 text-sm">å¾Œç«¯éŒ¯èª¤: ${data.error}</div>`;
                    return;
                }

                let totalTWD = 0, totalJPY = 0;
                let exchangeHistoryHtml = '';
                
                if (data.exchanges && data.exchanges.length > 0) {
                    data.exchanges.forEach(ex => {
                        totalTWD += parseInt(ex.twd);
                        totalJPY += parseInt(ex.jpy);
                        exchangeHistoryHtml += `<div class="flex justify-between border-b border-gray-100 pb-1"><span>${ex.date} ${ex.who}</span><span>NT$${ex.twd} â†’ Â¥${ex.jpy}</span></div>`;
                    });
                    
                    if (totalJPY > 0) AVG_RATE = (totalTWD / totalJPY); 
                }
                
                document.getElementById('avg-rate-display').innerText = AVG_RATE.toFixed(4);
                document.getElementById('display-rate').innerText = AVG_RATE.toFixed(4);
                document.getElementById('exchange-history').innerHTML = exchangeHistoryHtml || '<div class="text-gray-400">å°šç„¡ç´€éŒ„</div>';

                let totalSpentTWD = 0;
                let spentPublicJPY = 0;
                let xiangPaid = 0, yanPaid = 0;
                let extraDebt_YanOwesXiang = 0; 
                let html = '';

                data.expenses.forEach(bill => {
                    let twd = 0;
                    let displaySubText = '';

                    if (bill.currency === 'JPY') {
                        const appliedRate = bill.rate ? parseFloat(bill.rate) : AVG_RATE;
                        twd = Math.round(bill.amount * appliedRate);
                        displaySubText = `â‰ˆ NT$${twd} <span class="text-xs text-gray-300 ml-1">(åŒ¯ç‡: ${appliedRate.toFixed(4)})</span>`;
                        if (String(bill.payer).startsWith('å…¬è²»')) spentPublicJPY += parseInt(bill.amount);
                    } else {
                        twd = parseInt(bill.amount);
                    }

                    if (bill.payer === 'å…¬è²»' || bill.payer.includes('å…±åŒ')) {} 
                    else if (bill.payer === 'å…¬è²»-ç¿”') extraDebt_YanOwesXiang -= (twd / 2); 
                    else if (bill.payer === 'å…¬è²»-å½¥') extraDebt_YanOwesXiang += (twd / 2);
                    else {
                        totalSpentTWD += twd;
                        if (bill.payer.includes('ç¿”')) xiangPaid += twd;
                        if (bill.payer.includes('å½¥')) yanPaid += twd;
                    }

                    const displayAmt = (bill.currency === 'JPY') ? `Â¥${bill.amount}` : `$${bill.amount}`;
                    const rowData = JSON.stringify(bill).replace(/"/g, '"');
                    let payerLabel = bill.payer.split(' ')[0];
                    if(bill.payer === 'å…¬è²»-ç¿”') payerLabel = 'å…¬è²»(ç¿”)';
                    if(bill.payer === 'å…¬è²»-å½¥') payerLabel = 'å…¬è²»(å½¥)';

                    html += `<div class="bg-white border border-gray-100 rounded-xl p-3 shadow-sm flex justify-between items-center relative group"><div><div class="font-bold text-gray-800 text-sm">${bill.item}</div><div class="text-xs text-gray-500 mt-1 flex items-center gap-2"><span class="bg-gray-100 px-2 py-0.5 rounded text-gray-600 font-medium">${payerLabel}</span><span class="opacity-75">${bill.date}</span></div>${bill.note ? `<div class="text-xs text-gray-400 mt-1">${bill.note}</div>` : ''}</div><div class="text-right flex flex-col items-end"><div class="font-bold text-cyan-700 text-lg">${displayAmt}</div><div class="text-[10px] text-gray-400">${displaySubText}</div><div class="flex gap-2 mt-1"><button onclick='editExpense(${rowData})' class="text-xs text-blue-400">ä¿®æ”¹</button><button onclick="deleteExpense(${bill.rowIndex})" class="text-xs text-red-300">åˆªé™¤</button></div></div></div>`;
                });

                document.getElementById('expense-list').innerHTML = html || '<div class="text-center text-gray-400 py-4 text-sm">ç›®å‰æ²’æœ‰å¸³ç›®</div>';
                document.getElementById('total-expense').innerText = totalSpentTWD.toLocaleString();
                
                const currentBalance = totalJPY - spentPublicJPY;
                document.getElementById('public-balance').innerText = currentBalance.toLocaleString();
                document.getElementById('public-balance-twd').innerText = Math.round(currentBalance * AVG_RATE).toLocaleString();

                updateSettlement(xiangPaid, yanPaid, extraDebt_YanOwesXiang);
                updateRateInputLogic(); 

            } catch (err) {
                listDiv.innerHTML = '<div class="text-center text-red-400 py-4 text-sm">è®€å–å¤±æ•—ï¼š' + err.message + '</div>';
            } finally {
                loadingMsg.classList.add('hidden');
                listDiv.style.opacity = '1';
            }
        }

        function updateSettlement(xiang, yan, extraDebt = 0) {
            const text = document.getElementById('settlement-text');
            const baseDiff = (xiang - yan) / 2;
            const finalDiff = baseDiff + extraDebt;
            const absVal = Math.round(Math.abs(finalDiff));
            
            if (absVal === 0) text.innerText = "ğŸ‰ å¹³è¡¡";
            else if (finalDiff > 0) text.innerHTML = `å½¥ çµ¦ ç¿” <span class="font-bold text-red-600">$${absVal.toLocaleString()}</span>`;
            else text.innerHTML = `ç¿” çµ¦ å½¥ <span class="font-bold text-red-600">$${absVal.toLocaleString()}</span>`;
        }

        function editExpense(data) {
            document.getElementById('edit-row-id').value = data.rowIndex;
            document.getElementById('acc-date').value = data.date;
            document.getElementById('acc-payer').value = data.payer;
            document.getElementById('acc-item').value = data.item;
            document.getElementById('acc-currency').value = data.currency;
            document.getElementById('acc-amount').value = data.amount;
            document.getElementById('acc-note').value = data.note;
            document.getElementById('acc-custom-rate').value = data.rate || AVG_RATE;
            document.getElementById('form-title').innerText = "âœï¸ ä¿®æ”¹å¸³ç›®";
            document.getElementById('btn-submit-acc').innerText = "ç¢ºèªæ›´æ–°";
            document.getElementById('btn-submit-acc').classList.replace('bg-cyan-600', 'bg-blue-600');
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            updateRateInputLogic(); 
            document.getElementById('app-container').scrollTo({ top: 0, behavior: 'smooth' });
        }
        async function deleteExpense(rowIndex) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            try { await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'delete_expense', row: rowIndex }) }); alert('ğŸ—‘ï¸ å·²åˆªé™¤'); fetchData(); } catch (e) { alert('å¤±æ•—'); }
        }
        function resetFormState() {
            document.getElementById('account-form').reset();
            document.getElementById('edit-row-id').value = '';
            document.getElementById('acc-date').valueAsDate = new Date();
            document.getElementById('form-title').innerText = "ğŸ’¸ æ–°å¢æ¶ˆè²»";
            document.getElementById('btn-submit-acc').innerText = "è¨˜å¸³";
            document.getElementById('btn-submit-acc').classList.replace('bg-blue-600', 'bg-cyan-600');
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            updateRateInputLogic();
        }
        
        const jpyInput = document.getElementById('input-jpy');
        const twdInput = document.getElementById('input-twd');
        function toggleCalc() {
            const modal = document.getElementById('calc-modal');
            modal.classList.toggle('hidden-modal');
            modal.classList.toggle('show-modal');
        }
        jpyInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if (!isNaN(val)) twdInput.value = Math.round(val * AVG_RATE);
            else twdInput.value = '';
        });
        twdInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if (!isNaN(val)) jpyInput.value = Math.round(val / AVG_RATE);
            else jpyInput.value = '';
        });
    </script>
</body>
</html>
